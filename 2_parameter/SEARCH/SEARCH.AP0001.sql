SET DEFINE OFF;DELETE FROM SEARCH WHERE 1 = 1 AND NVL(SEARCHCODE,'NULL') = NVL('AP0001','NULL');Insert into SEARCH   (SEARCHCODE, SEARCHTITLE, EN_SEARCHTITLE, SEARCHCMDSQL, OBJNAME, FRMNAME, ORDERBYCMDSQL, TLTXCD, CNTRECORD, ROWPERPAGE, AUTOSEARCH, INTERVAL, AUTHCODE, ROWLIMIT, CMDTYPE, CONDDEFFLD, BANKINQ, BANKACCT) Values   ('AP0001', '1401 - Quản lý thông tin hợp đồng đặt mua physical', '1401 - Manage physical subscription agreement ', 'SELECT A1.<@CDCONTENT> TYPE, T.TLTXCD, T.ID CRPHYSAGREEID, T.NO, CF.CUSTODYCD, T.CODEID, T.CITAD, T.BANKCODE, T.BANKACCTNO, T.CLVALUE, T.CLVALUE REMAMT,T.BNAME
      , SB.SYMBOL, CUR.SHORTCD, CUR.CCYNAME, T.TAX, T.CLVALUE AMT, CF.FULLNAME,(''FCT_Securities transferring_''||SB.SYMBOL||''_orginal amount: VND ''||trim(to_char(T.CLVALUE,''999,999,999,999''))) MEMO
FROM
    (   SELECT ''1407'' TLTXCD, CR.CRPHYSAGREEID ID, CR.NO, CR.NAME, 0 TAX
            , CR.CUSTODYCD, CR.ACCTNO, CR.CODEID, CR.CITAD, CR.BANKCODE, CR.BANKACCTNO
            , CR.CLVALUE
            , CASE WHEN CRLOG.AAMT IS NULL THEN CR.CLVALUE ELSE (CR.CLVALUE - CRLOG.AAMT) END REMAMT
            , CR.BNAME
        FROM (SELECT * FROM CRPHYSAGREE WHERE DELTD <> ''Y'' AND NVL(PAYSTATUS,''A'') NOT IN (''T'')) CR, CRBBANKLIST CRB,
             (SELECT CRL.CRPHYSAGREEID, SUM(CRL.AMT) AAMT FROM CRPHYSAGREE_LOG CRL WHERE CRL.TYPE = ''T'' AND CRL.DELTD <> ''Y'' GROUP BY CRL.CRPHYSAGREEID) CRLOG
        WHERE CR.CRPHYSAGREEID = CRLOG.CRPHYSAGREEID(+) AND
              CR.STATUS = ''A'' AND
              (CR.CLVALUE > CRLOG.AAMT or CRLOG.AAMT IS NULL) AND
              CR.CITAD = CRB.CITAD(+)
        UNION ALL
        SELECT ''1400'' TLTXCD, TO_CHAR(AP.AUTOID) ID, AP.NO, AP.NAME, CRS.TAX
            , CRS.BUYCUSTODYCD CUSTODYCD, CRS.CUSTID ACCTNO, AP.CODEID, '''' CITAD, AP.BANKCODE,  AP.BANKACCTNO
            , CRS.NETAMT CLVALUE
            , (CASE WHEN CRLOG.AAMT IS NULL THEN (CASE WHEN AP.taxableparty =''001'' AND AP.deductionplace =''001'' THEN CRS.NETAMT ELSE CRS.AMT END) ELSE ((CASE WHEN AP.taxableparty =''001'' AND AP.deductionplace =''001'' THEN CRS.NETAMT ELSE CRS.AMT END) - CRLOG.AAMT) END) REMAMT
            , NULL BNAME
        FROM APPENDIX AP, CRPHYSAGREE_SELL_LOG CRS,
        (SELECT CRL.APPENDIXID, SUM(CRL.AMT) AAMT FROM CRPHYSAGREE_LOG CRL WHERE CRL.TYPE = ''T'' AND CRL.DELTD <> ''Y'' GROUP BY CRL.APPENDIXID) CRLOG
        WHERE AP.AUTOID = CRS.APPENDIXID AND CRS.BUYMEMBER =''SHV'' AND
              AP.STATUS = ''P'' AND
              AP.AUTOID = CRLOG.APPENDIXID(+) AND
              (AP.CLVALUE > CRLOG.AAMT or CRLOG.AAMT IS NULL)
    ) T, SBSECURITIES SB, SBCURRENCY CUR, ALLCODE A1, CFMAST CF
WHERE  T.CODEID = SB.CODEID AND
       SB.CCYCD = CUR.CCYCD AND
       A1.CDTYPE = ''AP'' AND A1.CDNAME =''REFTYPE'' AND A1.CDVAL = T.TLTXCD AND
       T.ACCTNO = CF.CUSTID', 'AP0001', NULL, NULL, '1401', 0, 5000, 'N', 1, 'NNNNYNYNNNN', 'Y', 'T', NULL, 'N', NULL);COMMIT;