SET DEFINE OFF;DELETE FROM SEARCH WHERE 1 = 1 AND NVL(SEARCHCODE,'NULL') = NVL('CRBVOUCHERSE','NULL');Insert into SEARCH   (SEARCHCODE, SEARCHTITLE, EN_SEARCHTITLE, SEARCHCMDSQL, OBJNAME, FRMNAME, ORDERBYCMDSQL, TLTXCD, CNTRECORD, ROWPERPAGE, AUTOSEARCH, INTERVAL, AUTHCODE, ROWLIMIT, CMDTYPE, CONDDEFFLD, BANKINQ, BANKACCT) Values   ('CRBVOUCHERSE', 'Quản lý bảng kê CK', 'List of stock voucher management', '
SELECT MST.AUTOID, MST.VERSION, MST.TXDATE, MST.AFFECTDATE, MST.REFBANK,MDL.SYMBOL,MDL.QTTY, MST.CREATETST, MST.SENDTST,
FN_CRB_GETVOUCHERNO(MST.TRFCODE, MST.TXDATE, MST.VERSION) VOUCHERNO,
A0.CDCONTENT DESC_STATUS, A1.CDCONTENT DESC_TRFCODE, ERR.ERRDESC,
DECODE(MST.STATUS,''P'',''Y'',''N'') APRALLOW, DECODE(MST.STATUS,''P'',''Y'',''N'') EDITALLOW
FROM CRBTRFLOG MST, ALLCODE A0, ALLCODE A1,DEFERROR ERR, (
    SELECT DTL.VERSION || DTL.TRFCODE || DTL.BANKCODE || TO_CHAR(DTL.TXDATE,''DDMMRRRR'') JOINKEY,
    DTL.VERSION,DTL.TRFCODE,DTL.BANKCODE,DTL.TXDATE,MAX(A.SYMBOL) SYMBOL, sum(QTTY) QTTY FROM
    (
        SELECT A.REQID,A.TRFCODE,MAX(A.SYMBOL_R) SYMBOL, MAX(A.QTTY) QTTY
        FROM
        (
        SELECT *
        FROM  (
          SELECT DTL.REQID,MST.TRFCODE, TXAMT QTTY, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
          FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.STATUS<>''D''
          AND MST.REQID=DTL.REQID AND MST.TRFCODE IN (
            ''SETRFCLOSE'',''SESENDWITHDRAW'',''SESENDDEPOSIT'',
            ''SEREJECTWITHDRAW'',''SEREJECTDEPOSIT'',''SEODDLOT'',''SEODDLOC''
          )
        ) PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN (''SYMBOL'' as SYMBOL))
        ORDER BY REQID
        ) A GROUP BY A.REQID,A.TRFCODE
    ) A,CRBTRFLOGDTL DTL
    WHERE A.REQID=DTL.REFREQID
    GROUP BY DTL.VERSION,DTL.TRFCODE,DTL.BANKCODE,DTL.TXDATE
) MDL
WHERE A0.CDTYPE=''RM'' AND A0.CDNAME=''TRFLOGSTS'' AND A0.CDVAL=MST.STATUS
AND A1.CDTYPE=''SY'' AND A1.CDNAME=''TRFCODE'' AND A1.CDVAL=MST.TRFCODE
AND MST.TRFCODE IN (''SETRFCLOSE'',''SESENDWITHDRAW'',''SESENDDEPOSIT'',''SEREJECTWITHDRAW'',''SEREJECTDEPOSIT'',''SEODDLOT'',''SEODDLOC'')
AND MST.VERSION || MST.TRFCODE || MST.REFBANK || TO_CHAR(MST.TXDATE,''DDMMRRRR'') = MDL.JOINKEY(+)
AND MST.STATUS <> ''P''
AND MST.ERRCODE=ERR.ERRNUM(+)
', 'CRBVOUCHER', 'frmPRINT', NULL, NULL, NULL, 5000, 'N', 1, 'NNNNYYNNNNY', 'Y', 'T', NULL, 'N', NULL);COMMIT;