SET DEFINE OFF;DELETE FROM SEARCH WHERE 1 = 1 AND NVL(SEARCHCODE,'NULL') = NVL('CA1004','NULL');Insert into SEARCH   (SEARCHCODE, SEARCHTITLE, EN_SEARCHTITLE, SEARCHCMDSQL, OBJNAME, FRMNAME, ORDERBYCMDSQL, TLTXCD, CNTRECORD, ROWPERPAGE, AUTOSEARCH, INTERVAL, AUTHCODE, ROWLIMIT, CMDTYPE, CONDDEFFLD, BANKINQ, BANKACCT) Values   ('CA1004', 'Chốt danh sách đăng ký phân bổ thực hiện quyền (đối chiếu all)', 'Summary list of CA registering (compare all)', 'SELECT DT.*,
(CASE WHEN DT.MODQTTY_TMP = 1 THEN DT.QTTY_TMP + 1 ELSE DT.QTTY_TMP END) QTTY,
(CASE WHEN DT.CATYPEVALUE IN (''011'',''017'',''020'',''021'') THEN (CASE WHEN DT.MODQTTY_TMP = 1 THEN 0 ELSE DT.MODQTTY_TMP END) * DT.EXPRICE
      WHEN DT.CATYPEVALUE IN (''023'',''015'',''016'') THEN DT.AMT_TMP
      ELSE (CASE WHEN DT.MODQTTY_TMP = 1 THEN DT.QTTY_TMP + 1 ELSE DT.QTTY_TMP END) * DT.EXPRICE
      END
) AMT,
(CASE WHEN DT.MODQTTY_TMP = 1 THEN 0 ELSE DT.MODQTTY_TMP END) MODQTTY
FROM
(
    SELECT DT.*, 
    (CASE WHEN DT.CATYPEVALUE IN (''023'',''015'',''016'') THEN DT.QTTY_TMP1 ELSE TRUNC(DT.TRADE * DT.RATE) END) QTTY_TMP,
    (CASE WHEN DT.CATYPEVALUE IN (''023'',''015'',''016'') THEN DT.AMT_TMP1 ELSE 0 END) AMT_TMP,
    (CASE WHEN DT.CATYPEVALUE IN (''011'',''017'',''020'',''021'') THEN FN_ROUND_AMTQTTY((DT.TRADE * DT.RATE) - TRUNC((DT.TRADE * DT.RATE)), DT.ROUNDMETHOD, DT.CIROUNDTYPE)
         ELSE (DT.TRADE * DT.RATE) - TRUNC(DT.TRADE * DT.RATE, DT.ROUNDTYPE)
    END) MODQTTY_TMP
    FROM(
        SELECT MCF.CUSTODYCD, CAS.CAMASTID,
            MAX(MCF.CIFID) CIFID, MAX(MCF.IDPLACE) IDPLACE, MAX(MCF.ADDRESS) ADDRESS, MAX(MCF.FULLNAME) FULLNAME,
            DECODE(SUBSTR(MCF.CUSTODYCD,4,1), ''F'', MAX(CF.TRADINGCODE), MAX(MCF.IDCODE)) IDCODE,
            DECODE(SUBSTR(MCF.CUSTODYCD,4,1), ''F'', MAX(CF.TRADINGCODEDT), MAX(MCF.IDDATE)) IDDATE,
            MAX(CAS.AUTOID) AUTOID, MAX(CAS.AFACCTNO) AFACCTNO, MAX(CAS.CODEID) CODEID,
            SUM(CASE WHEN CA.CATYPE = ''040'' THEN CAS.QTTY ELSE CAS.BALANCE END) BALANCE, 
            SUM(CAS.TRADE) TRADE, 
            SUM(CAS.QTTY) QTTY_TMP1, 
            SUM(CAS.AMT) AMT_TMP1,
            MAX(CA.REPORTDATE) REPORTDATE, MAX(CA.ACTIONDATE) ACTIONDATE, MAX(CA.ISINCODE) ISINCODE, 
            MAX(CA.EXPRICE) EXPRICE, 
            MAX(CA.FRATE) RATE,
            MAX(CA.ROUNDMETHOD) ROUNDMETHOD, MAX(CA.CIROUNDTYPE) CIROUNDTYPE, MAX(CA.ROUNDTYPE) ROUNDTYPE,
            MAX(SYM.SYMBOL) SYMBOL,
            MAX(A0.CDVAL) CATYPEVALUE, MAX(A0.<@CDCONTENT>) CATYPE, MAX(A1.<@CDCONTENT>) STATUS
        FROM CASCHD CAS, SBSECURITIES SYM, AFMAST AF, CFMAST CF, CFMAST MCF,
            (
                SELECT CA.*,
                TRUNC(
                    CASE WHEN CATYPE IN (''009'',''011'',''020'') THEN TO_NUMBER(NVL(SUBSTR(DEVIDENTSHARES,INSTR(DEVIDENTSHARES,''/'') + 1,LENGTH(DEVIDENTSHARES)),''0'')) / TO_NUMBER(NVL(SUBSTR(DEVIDENTSHARES,0,INSTR(DEVIDENTSHARES,''/'') - 1),''1''))
                    WHEN CATYPE IN (''021'',''023'',''017'') THEN TO_NUMBER(NVL(SUBSTR(EXRATE,INSTR(EXRATE,''/'') + 1,LENGTH(EXRATE)),''0'')) / TO_NUMBER(NVL(SUBSTR(EXRATE,0,INSTR(EXRATE,''/'') - 1),''1''))
                    WHEN CATYPE IN (''012'',''013'') THEN 1/SPLITRATE
                    WHEN CATYPE IN (''014'') THEN ( TO_NUMBER(NVL(SUBSTR(RIGHTOFFRATE,INSTR(RIGHTOFFRATE,''/'') + 1,LENGTH(RIGHTOFFRATE)),''0'')) * TO_NUMBER(NVL(SUBSTR(EXRATE,INSTR(EXRATE,''/'') + 1,LENGTH(EXRATE)),''0'')) ) / ( TO_NUMBER(NVL(SUBSTR(RIGHTOFFRATE,0,INSTR(RIGHTOFFRATE,''/'') - 1),''1'')) * TO_NUMBER(NVL(SUBSTR(EXRATE,0,INSTR(EXRATE,''/'') - 1),''1'')) )
                    ELSE 1
                    END
                ,10) FRATE
                FROM CAMAST CA
                WHERE CA.DELTD=''N''
            ) CA,
            (SELECT * FROM ALLCODE WHERE CDNAME = ''CATYPE'' AND CDTYPE = ''CA'') A0,
            (SELECT * FROM ALLCODE WHERE CDNAME = ''CASTATUS'' AND CDTYPE = ''CA'') A1
        WHERE CA.CATYPE = A0.CDVAL(+)
        AND CAS.STATUS = A1.CDVAL(+)
        AND CAS.CAMASTID = CA.CAMASTID
        AND CA.CODEID = SYM.CODEID
        AND CAS.AFACCTNO = AF.ACCTNO
        AND AF.CUSTID = CF.CUSTID
        AND NVL(CF.MCUSTODYCD, CF.CUSTODYCD) = MCF.CUSTODYCD
        AND CAS.DELTD =''N''
        GROUP BY MCF.CUSTODYCD, CAS.CAMASTID
    ) DT
) DT WHERE 0=0', 'CASCHD', 'frmCASCHD', '', '', NULL, 5000, 'N', 1, 'NYNNYYYNNY', 'Y', 'T', '', 'N', '');COMMIT;