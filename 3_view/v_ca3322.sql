SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW V_CA3322
(CAAUTOID, CAMASTID, CUSTODYCD, ISINCODE, CATYPE, 
 CODEID, EXCODEID, SYMBOL, SYMBOLDIS, STATUS, 
 PARVALUE, EXPARVALUE, PITRATE, REPORTDATE, ACTIONDATE, 
 DESCRIPTION, FULLNAME, IDCODE, ADDRESS, CASTATUS, 
 CIFID, PITRATEMETHOD, MCUSTODYCD, MCIFID, BALANCE, 
 PBALANCE, QTTY, AMT, TRADE)
AS 
SELECT VW.CAAUTOID, VW.CAMASTID,VW.CUSTODYCD,VW.ISINCODE,VW.CATYPE,VW.CODEID,VW.EXCODEID,VW.SYMBOL,VW.SYMBOLDIS,VW.STATUS,VW.PARVALUE,VW.PARVALUE EXPARVALUE,VW.PITRATE,
    VW.REPORTDATE,VW.ACTIONDATE,VW.DESCRIPTION,VW.FULLNAME,VW.IDCODE,VW.ADDRESS,VW.CASTATUS,VW.CIFID,VW.PITRATEMETHOD,VW.MCUSTODYCD,VW.MCIFID,
    SUM(VW.BALANCE) BALANCE,SUM(VW.PBALANCE) PBALANCE,SUM(VW.QTTY) QTTY,SUM(VW.AMT) AMT,SUM(VW.TRADE) TRADE
FROM
(
    SELECT CA.AUTOID, CA.TRADE, CA.PBALANCE, CA.AFACCTNO, CA.CODEID, CA.EXCODEID, CA.QTTY, CA.STATUS, SUBSTR(CA.CAMASTID,1,4) || '.' || SUBSTR(CA.CAMASTID,5,6) || '.' ||SUBSTR(CA.CAMASTID,11,6) CAMASTID,
           CAMAST.AUTOID CAAUTOID, CAMAST.DESCRIPTION, CAMAST.STATUS CASTATUS, CAMAST.ISINCODE, CAMAST.REPORTDATE REPORTDATE, CAMAST.ACTIONDATE, CAMAST.PITRATE, CAMAST.CATYPE, CAMAST.PITRATEMETHOD,
           CF.CUSTODYCD, CF.FULLNAME, CF.IDCODE, CF.ADDRESS, CF.CIFID, CF.MCUSTODYCD, CF.MCIFID,
           SYM.PARVALUE PARVALUE, SYM.SYMBOL SYMBOLDIS,
           EXSYM.PARVALUE EXPARVALUE,
           (CASE WHEN CAMAST.CATYPE='014' THEN CA.BALANCE ELSE 0 END) BALANCE,
           (CASE WHEN NVL(CAMAST.TOCODEID,'A') = 'A' THEN SYM.SYMBOL ELSE SYMTO.SYMBOL END ) SYMBOL,
           (CASE WHEN CAMAST.CATYPE IN ('016') THEN CA.INTAMT ELSE CA.AMT END ) AMT
    FROM CASCHD_LIST_FA CA, SBSECURITIES SYM, SBSECURITIES SYMTO, SBSECURITIES EXSYM, CAMAST, AFMAST AF, CFMAST CF
    WHERE CA.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND CA.CAMASTID = CAMAST.CAMASTID
    AND CAMAST.CODEID=SYM.CODEID
    AND SYMTO.CODEID = (CASE WHEN NVL(CAMAST.TOCODEID,'A') <> 'A' THEN CAMAST.TOCODEID ELSE CAMAST.CODEID END)
    AND CA.DELTD = 'N'
    AND CAMAST.STATUS = 'N'
    AND EXSYM.CODEID = (CASE WHEN CAMAST.EXCODEID IS NULL THEN CAMAST.CODEID ELSE CAMAST.EXCODEID END)
) VW
GROUP BY VW.CAAUTOID, VW.CAMASTID,VW.CUSTODYCD,VW.ISINCODE,VW.CATYPE,VW.CODEID,VW.EXCODEID,VW.SYMBOL,VW.SYMBOLDIS,VW.STATUS,VW.PARVALUE,VW.CIFID,VW.REPORTDATE,VW.REPORTDATE,VW.ACTIONDATE,VW.DESCRIPTION,VW.FULLNAME,
VW.IDCODE,VW.ADDRESS,VW.CASTATUS,VW.PITRATEMETHOD,VW.PITRATE,VW.MCUSTODYCD,VW.MCIFID
/
