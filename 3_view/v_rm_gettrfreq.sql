SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW V_RM_GETTRFREQ
(REQID, OBJNAME, TXDATE, AFFECTDATE, OBJKEY, 
 TRFCODE, TRFNAME, BANKCODE, BANKNAME, CUSTODYCD, 
 AFACCTNO, BANKACCTNO, BANKACCTNAME, DESACCTNO, DESACCTNAME, 
 TXAMT, STATUS, NOTES)
AS 
SELECT MST.REQID,MST.OBJNAME, MST.TXDATE,MST.AFFECTDATE, MST.OBJKEY,MST.TRFCODE,
A1.CDCONTENT TRFNAME,MST.BANKCODE,A2.CDCONTENT BANKNAME, CF.CUSTODYCD,MST.AFACCTNO,
MST.BANKACCT BANKACCTNO,CF.FULLNAME BANKACCTNAME, RF.DESACCTNO_R DESACCTNO,
RF.DESACCTNAME_R DESACCTNAME,MST.TXAMT,MST.STATUS,MST.NOTES
FROM CRBTXREQ MST,AFMAST AF,CFMAST CF,CRBDEFBANK CRB,ALLCODE A1,ALLCODE A2,
 (SELECT *
FROM   (SELECT DTL.REQID, DTL.FLDNAME, NVL(DTL.CVAL,DTL.NVAL) REFVAL
        FROM   CRBTXREQ MST, CRBTXREQDTL DTL WHERE MST.STATUS IN ('P','A','C','E') AND MST.REQID=DTL.REQID)
PIVOT  (MAX(REFVAL) AS R FOR (FLDNAME) IN
('DESACCTNO' as DESACCTNO,'DESACCTNAME' as DESACCTNAME))
ORDER BY REQID) RF
WHERE MST.REQID=RF.REQID AND MST.AFACCTNO = AF.ACCTNO
AND AF.CUSTID=CF.CUSTID AND MST.BANKCODE=CRB.BANKCODE AND MST.STATUS='P'
AND MST.TRFCODE = A1.CDVAL AND A1.CDNAME='TRFCODE'
AND MST.BANKCODE = A2.CDVAL AND A2.CDNAME='BANKNAME' AND A2.CDTYPE='CF'
/
