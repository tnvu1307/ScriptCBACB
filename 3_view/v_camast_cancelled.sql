SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW V_CAMAST_CANCELLED
(VALUE, AUTOID, SYMBOL, CAMASTID, CODEID, 
 EXCODEID, TYPEID, CATYPE, KHQDATE, REPORTDATE, 
 DUEDATE, ACTIONDATE, BEGINDATE, EXPRICE, EXRATE, 
 RIGHTOFFRATE, OPTCODEID, DEVIDENTSHARES, SPLITRATE, INTERESTRATE, 
 DESCRIPTION, CONTENTS, INTERESTPERIOD, STATUS, FRDATERETAIL, 
 TODATERETAIL, TRFLIMIT, PURPOSEDESC, MEETINGPLACE, ROPRICE, 
 TVPRICE, RATE, PITRATE, PITRATEMETHOD_CD, PITRATEMETHOD, 
 CATYPEVAL, FRDATETRANSFER, TODATETRANSFER, APRALLOW, PITRATESE, 
 INACTIONDATE, AMT, QTTY, TAXAMT, AMTAFTER, 
 STATUSVAL, ISCHANGESTT, MAKERID, APPRVID, ISRIGHTOFF, 
 TRADE, TRADE3375, TOSYMBOL, TOCODEID, CAQTTY, 
 CANCELDATE, RECEIVEDATE, ISINCODE, ADVDESC, TYPERATE, 
 DEVIDENTRATE, DEVIDENTVALUE, REMAINDEVIDENTRATE, REMAINDEVIDENTVALUE, TRADEDATE, 
 RATE1, STATUS1, MEETINGDATETIME, FRACTIONALSHARE, DEBITDATE, 
 FORMOFPAYMENT, DELTD, INSTRUCTION, RIGHTTRANSDL, INSDEADLINE, 
 PSTATUS, VSDID)
AS 
SELECT MST.CAMASTID VALUE, MST.AUTOID,SYM.SYMBOL,
           SUBSTR(MST.CAMASTID,1,4)||'.'||SUBSTR(MST.CAMASTID,5,6)||'.'||SUBSTR(MST.CAMASTID,11,6) CAMASTID,
           MST.CODEID, MST.EXCODEID, CATYPE TYPEID, /*A1.CDCONTENT*/ CATYPE, GETPREVDATE(MST.REPORTDATE,1) KHQDATE, MST.REPORTDATE, MST.DUEDATE,
           MST.ACTIONDATE, MST.BEGINDATE, MST.EXPRICE, MST.EXRATE, MST.RIGHTOFFRATE, MST.OPTCODEID, MST.DEVIDENTSHARES,
           MST.SPLITRATE, MST.INTERESTRATE, MST.DESCRIPTION,MST.DESCRIPTION CONTENTS, MST.INTERESTPERIOD, MST.STATUS, MST.FRDATERETAIL,
           MST.TODATERETAIL, MST.TRFLIMIT,MST.PURPOSEDESC,MST.MEETINGPLACE,
          (CASE WHEN MST.CATYPE='014' THEN MST.EXPRICE END) ROPRICE,
          (CASE WHEN MST.CATYPE IN ('011','021','017','020') THEN MST.EXPRICE END)  TVPRICE,
          (CASE WHEN MST.EXRATE IS NOT NULL THEN MST.EXRATE
               ELSE (CASE WHEN MST.RIGHTOFFRATE IS NOT NULL THEN MST.RIGHTOFFRATE
                          ELSE (CASE WHEN MST.DEVIDENTRATE IS NOT NULL AND MST.DEVIDENTRATE <> '0' THEN MST.DEVIDENTRATE
                                     ELSE (CASE WHEN SPLITRATE IS NOT NULL THEN MST.SPLITRATE
                                                ELSE (CASE WHEN MST.INTERESTRATE IS NOT NULL THEN INTERESTRATE
                                                           ELSE (CASE WHEN DEVIDENTSHARES IS NOT NULL THEN DEVIDENTSHARES
                                                                      ELSE '0' END)END)END)END) END)END) RATE,
          MST.PITRATE, MST.PITRATEMETHOD PITRATEMETHOD_CD, MST.PITRATEMETHOD PITRATEMETHOD,
          MST.CATYPE CATYPEVAL, MST.FRDATETRANSFER, MST.TODATETRANSFER, (CASE WHEN MST.STATUS IN ('P') THEN 'Y' ELSE 'N' END) APRALLOW,
          PITRATESE,   NVL(INACTIONDATE,ACTIONDATE) INACTIONDATE, NVL(SCHD.AMT,0) AMT, NVL(SCHD.QTTY,0) QTTY,
          NVL(SCHD.TAXAMT,0) TAXAMT,NVL(SCHD.AMTAFTER,0) AMTAFTER,
          MST.STATUS STATUSVAL, (CASE WHEN MST.STATUS='S' THEN 1 ELSE 0 END) ISCHANGESTT,
          MAKER.TLNAME MAKERID,APPRV.TLNAME APPRVID,
          (CASE WHEN MST.CATYPE='014' THEN 1 ELSE 0 END) ISRIGHTOFF,
          NVL(SCHD2.TRADE,0) TRADE, NVL(SE.TRADE,0) TRADE3375,
          TOSYM.SYMBOL TOSYMBOL,NVL(MST.TOCODEID,MST.CODEID) TOCODEID,
          NVL(SCHD2.QTTY,0) CAQTTY, NVL(MST.CANCELDATE,TO_DATE('20/03/2050','DD/MM/RRRR')) CANCELDATE,
          NVL(MST.RECEIVEDATE,TO_DATE('20/03/2050','DD/MM/RRRR')) RECEIVEDATE,
          MST.ISINCODE, ADVDESC, NVL(MST.TYPERATE,'-') TYPERATE, to_number(NVL(MST.DEVIDENTRATE,0)) DEVIDENTRATE,  NVL(MST.DEVIDENTVALUE,0) DEVIDENTVALUE,
          (to_number(NVL(MST.DEVIDENTRATE,0)) - to_number(NVL(DTL.REMAINDEVIDENTRATE,0))) REMAINDEVIDENTRATE,
          (NVL(MST.DEVIDENTVALUE,0) - NVL(DTL.REMAINDEVIDENTVALUE,0)) REMAINDEVIDENTVALUE,
          MST.TRADEDATE,MST.DEVIDENTSHARES RATE1, MST.STATUS STATUS1,MST.MEETINGDATETIME, MST.FRACTIONALSHARE,
          MST.DEBITDATE,MST.FORMOFPAYMENT,mst.deltd,MST.INSTRUCTION,MST.RIGHTTRANSDL,MST.INSDEADLINE,MST.PSTATUS,mst.VSDID
    FROM CAMAST MST, SBSECURITIES SYM, --ALLCODE A1, ALLCODE A2, ALLCODE A3,
          (
            SELECT SUM(CASE WHEN SCHD.ISCI= 'Y' THEN SCHD.AMT ELSE 0 END) AMT,
                   SUM( CASE WHEN SCHD.ISSE ='Y' THEN SCHD.QTTY ELSE 0 END) QTTY,
                   SUM(ROUND(MST1.PITRATE *
                           ( CASE WHEN
                                  (CASE WHEN SCHD.PITRATEMETHOD='##' THEN MST1.PITRATEMETHOD ELSE SCHD.PITRATEMETHOD END) ='SC'
                             THEN 1 ELSE 0 END)
                            *(CASE WHEN ( SCHD.ISCI= 'Y' AND CF.VAT='Y') THEN (CASE WHEN  MST1.CATYPE='016' THEN SCHD.INTAMT ELSE SCHD.AMT END)
                                   ELSE 0 END) /100
                        ))TAXAMT,
                  SUM((CASE WHEN SCHD.ISCI= 'Y' THEN SCHD.AMT ELSE 0 END) - ROUND(MST1.PITRATE
                             * ( CASE WHEN
                                  (CASE WHEN SCHD.PITRATEMETHOD='##' THEN MST1.PITRATEMETHOD ELSE SCHD.PITRATEMETHOD END) ='SC'
                             THEN 0 ELSE 1 END)*(CASE WHEN (SCHD.ISCI= 'Y' AND CF.VAT='Y') THEN (CASE WHEN  MST1.CATYPE='016' THEN SCHD.INTAMT ELSE SCHD.AMT END)
                                   ELSE 0 END) /100
                ))AMTAFTER, SCHD.CAMASTID
              FROM CASCHD SCHD,CAMAST MST1,AFMAST AF, AFTYPE AFT, CFMAST CF
              WHERE SCHD.DELTD='N' --AND MST1.DELTD='N'
                    AND AF.CUSTID = CF.CUSTID AND MST1.CAMASTID=SCHD.CAMASTID
                    AND SCHD.AFACCTNO=AF.ACCTNO AND AF.ACTYPE=AFT.ACTYPE
              GROUP BY SCHD.CAMASTID
            ) SCHD, TLPROFILES MAKER, TLPROFILES APPRV,
            (SELECT SUM(NVL(TRADE,0)) TRADE, SUM(NVL(QTTY,0)) QTTY, CAMASTID
                FROM CASCHD
                WHERE DELTD='N' AND ISEXEC <> 'N' GROUP BY CAMASTID
                ) SCHD2,
            (SELECT SUM(TRADE + MARGIN + WTRADE  + MORTAGE + BLOCKED + SECURED + REPO+ NETTING+ DTOCLOSE+ WITHDRAW ) TRADE, CODEID
                FROM SEMAST GROUP BY CODEID
                ) SE, SBSECURITIES TOSYM,
            (SELECT DTL1.CAMASTID,
                    SUM(DTL1.DEVIDENTRATE) DEVIDENTRATE,
                    SUM(DTL1.DEVIDENTVALUE) DEVIDENTVALUE,
                    SUM(DTL1.EXECRATE) EXECRATE,
                    SUM(DECODE(STATUS,'C',DTL1.DEVIDENTRATE)) REMAINDEVIDENTRATE,
                    SUM(DECODE(STATUS,'C',DTL1.DEVIDENTVALUE)) REMAINDEVIDENTVALUE
                FROM CAMASTDTL DTL1 WHERE DTL1.DELTD <> 'Y'
                GROUP BY DTL1.CAMASTID
                ) DTL
    WHERE MST.CODEID=SYM.CODEID AND MST.CODEID = SE.CODEID (+)
/*           AND A1.CDTYPE = 'CA'
           AND A1.CDNAME = 'CATYPE' AND A1.CDVAL = CATYPE
           AND A3.CDTYPE = 'CA' AND A3.CDNAME = 'PITRATEMETHOD'
           AND MST.PITRATEMETHOD = A3.CDVAL
           AND A2.CDTYPE = 'CA' AND A2.CDNAME = 'CASTATUS'
           AND MST.STATUS = A2.CDVAL */
          -- AND MST.DELTD = 'N'
           AND MST.CAMASTID = SCHD.CAMASTID(+)
           AND MST.CAMASTID = DTL.CAMASTID(+)
           AND MST.MAKERID = MAKER.TLID(+)
           AND MST.APPRVID = APPRV.TLID(+)
           AND MST.CAMASTID = SCHD2.CAMASTID(+)
           AND NVL(MST.TOCODEID,MST.CODEID) = TOSYM.CODEID
/
