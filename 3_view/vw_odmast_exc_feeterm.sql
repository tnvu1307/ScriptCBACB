SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW VW_ODMAST_EXC_FEETERM
(ORDERID, AUTOID, FORP, FEEAMT, LOTDAY, 
 LOTVAL, ROUNDTYP, RATIO, ODRNUM)
AS 
SELECT OD.ORDERID, RF.AUTOID, RF.FORP, RF.FEEAMT, RF.LOTDAY, RF.LOTVAL, RF.ROUNDTYP,
DECODE(RF.FORP,'P',RF.FEEAMT/100,RF.FEEAMT)/(RF.LOTDAY*RF.LOTVAL) RATIO, 0 ODRNUM
FROM ODMAST OD, DDMAST MST, DDTYPE TYP, CIFEEDEF RF
WHERE TYP.ACTYPE=MST.ACTYPE AND TYP.ACTYPE=RF.ACTYPE AND RF.FEETYPE='EXCBRK' AND RF.STATUS='A'
AND OD.EXECQTTY>0
AND MST.AFACCTNO=OD.AFACCTNO AND RF.CODEID=OD.CODEID
UNION ALL
--Ưu tiên theo SGDCK
SELECT OD.ORDERID, RF.AUTOID, RF.FORP, RF.FEEAMT, RF.LOTDAY, RF.LOTVAL, RF.ROUNDTYP,
DECODE(RF.FORP,'P',RF.FEEAMT/100,RF.FEEAMT)/(RF.LOTDAY*RF.LOTVAL) RATIO, 1 ODRNUM
FROM SBSECURITIES SB, ODMAST OD, DDMAST MST, DDTYPE TYP, CIFEEDEF RF
WHERE TYP.ACTYPE=MST.ACTYPE AND TYP.ACTYPE=RF.ACTYPE AND RF.FEETYPE='EXCBRK' AND RF.STATUS='A'
AND OD.EXECQTTY>0
AND MST.AFACCTNO=OD.AFACCTNO AND SB.CODEID=OD.CODEID AND SB.TRADEPLACE=RF.TRADEPLACE AND RF.CODEID IS NULL
AND (SB.SECTYPE=RF.SECTYPE OR DECODE(SB.SECTYPE,'001','111','002','111','007','111','008','111','003','222','006','222','')=RF.SECTYPE)
UNION ALL
--lấy theo loại chứng khoán
SELECT OD.ORDERID, RF.AUTOID, RF.FORP, RF.FEEAMT, RF.LOTDAY, RF.LOTVAL, RF.ROUNDTYP,
DECODE(RF.FORP,'P',RF.FEEAMT/100,RF.FEEAMT)/(RF.LOTDAY*RF.LOTVAL) RATIO, 2 ODRNUM
FROM SBSECURITIES SB, ODMAST OD, DDMAST MST, DDTYPE TYP, CIFEEDEF RF
WHERE TYP.ACTYPE=MST.ACTYPE AND TYP.ACTYPE=RF.ACTYPE AND RF.FEETYPE='EXCBRK' AND RF.STATUS='A'
AND OD.EXECQTTY>0
AND MST.AFACCTNO=OD.AFACCTNO AND SB.CODEID=OD.CODEID AND RF.TRADEPLACE='000' AND RF.CODEID IS NULL
AND (SB.SECTYPE=RF.SECTYPE OR DECODE(SB.SECTYPE,'001','111','002','111','007','111','008','111','003','222','006','222','')=RF.SECTYPE)
/
