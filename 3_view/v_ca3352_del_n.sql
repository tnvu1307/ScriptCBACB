SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW V_CA3352_DEL_N
(AUTOID, AMT, BALANCE, CAMASTID, AFACCTNO, 
 CATYPE, CODEID, EXCODEID, QTTY, AQTTY, 
 AAMT, INTAMT, DFAMT, SYMBOL, STATUS, 
 SEACCTNO, EXSEACCTNO, PARVALUE, EXPARVALUE, REPORTDATE, 
 ACTIONDATE, POSTINGDATE, DESCRIPTION, TASKCD, DUTYAMT, 
 FULLNAME, IDCODE, CUSTODYCD, ISDEBITSE, ISCOREBANK, 
 ISCOREBANKTEXT, TRADE, ISINCODE, TRFEEAMT, DDACCTNO, 
 DELTD)
AS 
SELECT  CA.AUTOID,
        /*
        (CASE WHEN CAMAST.CATYPE = '010' THEN (CASE WHEN CA.STATUS = 'K' THEN ROUND((100-CAMAST.EXERATE)/100,4) ELSE ROUND(CAMAST.EXERATE/100,4) END) ELSE 1 END)
                      *(CASE WHEN (CASE WHEN CA.PITRATEMETHOD <> '##' THEN CA.PITRATEMETHOD ELSE CAMAST.PITRATEMETHOD END) = 'SC' OR CF.VAT='N'
                                THEN CA.AMT ELSE (CASE WHEN CAMAST.CATYPE IN ('016','023','027')
                            THEN ROUND(CA.AMT-ROUND(CA.INTAMT*CAMAST.PITRATE/100))
                      ELSE ROUND(CA.AMT-ROUND(CA.AMT*CAMAST.PITRATE/100)) END ) END) AMT,
        */
        (CASE WHEN CAMAST.CATYPE = '010' THEN ROUND(NVL(CAD.EXECRATE, CAMAST.EXERATE) /100,4) ELSE 1 END)
                *(CASE WHEN (CASE WHEN CA.PITRATEMETHOD <> '##' THEN CA.PITRATEMETHOD ELSE CAMAST.PITRATEMETHOD END) = 'SC' OR CF.VAT='N'
                                THEN CA.AMT
                                ELSE (CASE WHEN CAMAST.CATYPE IN ('016','023','027') THEN ROUND(CA.AMT-ROUND(CA.INTAMT*CAMAST.PITRATE/100))
                                            --T9/2019 CW_PhaseII
                                            WHEN CAMAST.CATYPE = '024' THEN  ROUND(CA.AMT-round(LEAST(CA.AMT,CA.balance*CAMAST.EXPRICE*CAMAST.pitrate/100/(to_number(SUBSTR(SYM.EXERCISERATIO,0,INSTR(SYM.EXERCISERATIO,'/') - 1))/to_number(SUBSTR(SYM.EXERCISERATIO,INSTR(SYM.EXERCISERATIO,'/')+1,LENGTH(SYM.EXERCISERATIO)) )))
                                                    )
                                                )
                                            --End --T9/2019 CW_PhaseII
                                            ELSE ROUND(CA.AMT-ROUND(CA.AMT*CAMAST.PITRATE/100)) END ) END) AMT,
        CA.BALANCE, SUBSTR(CA.CAMASTID,1,4) || '.' || SUBSTR(CA.CAMASTID,5,6) || '.' || SUBSTR(CA.CAMASTID,11,6) CAMASTID,
        CA.AFACCTNO,A0.CDCONTENT CATYPE, CA.CODEID, CA.EXCODEID, CA.QTTY,--ROUND(CA.AMT) AMT,
        ROUND(CA.AQTTY)  AQTTY, ROUND(CA.AAMT) AAMT, ROUND(CA.INTAMT) INTAMT, ROUND(CA.DFAMT) DFAMT, SYM.SYMBOL, A1.CDCONTENT STATUS,
        CA.AFACCTNO || CA.CODEID  SEACCTNO,CA.AFACCTNO || (CASE WHEN CAMAST.EXCODEID IS NULL THEN CAMAST.CODEID ELSE CAMAST.EXCODEID END) EXSEACCTNO,
        SYM.PARVALUE PARVALUE, EXSYM.PARVALUE EXPARVALUE, CAMAST.REPORTDATE REPORTDATE, CAMAST.ACTIONDATE ,CAMAST.ACTIONDATE  POSTINGDATE,
        CAMAST.DESCRIPTION || (CASE WHEN CAMAST.CATYPE = '010' AND NVL(CAD.EXECRATE,0) < 100
                                        THEN ' ( thanh toan ' || NVL(CAD.EXECRATE,0) || '/100% con lai ' || CAMAST.EXERATE || '%'   
                                    ELSE NULL END) DESCRIPTION, CAMAST.TASKCD,
        --(CASE WHEN CAMAST.CATYPE = '010' THEN (CASE WHEN CA.STATUS = 'K' THEN ROUND((100-CAMAST.EXERATE)/100,4) ELSE ROUND(CAMAST.EXERATE/100,4) END) ELSE 1 END)
        (CASE WHEN CAMAST.CATYPE = '010' THEN ROUND(NVL(CAD.EXECRATE, CAMAST.EXERATE) /100,4) ELSE 1 END)
        *(CASE WHEN CF.VAT='Y'
               THEN ( CASE WHEN CAMAST.CATYPE IN ('016','023','027') THEN ROUND(CAMAST.PITRATE*CA.INTAMT/100)
                            --T9/2019 CW_PhaseII
                            WHEN CAMAST.CATYPE = '024' THEN round(LEAST(CA.AMT,CA.balance*CAMAST.EXPRICE*CAMAST.pitrate/100/(to_number(SUBSTR(SYM.EXERCISERATIO,0,INSTR(SYM.EXERCISERATIO,'/') - 1))/to_number(SUBSTR(SYM.EXERCISERATIO,INSTR(SYM.EXERCISERATIO,'/')+1,LENGTH(SYM.EXERCISERATIO)) ))
                                                    )
                                                )
                            --End --T9/2019 CW_PhaseII
                           ELSE ROUND(CAMAST.PITRATE*CA.AMT/100) END) ELSE 0 END) DUTYAMT,
        CF.FULLNAME, CF.IDCODE, CF.CUSTODYCD,
        --(CASE WHEN CAMAST.CATYPE IN ('016','023','027') THEN 1 ELSE 0 END) ISDEBITSE,
        (CASE WHEN CAMAST.CATYPE IN ('027') THEN 1 ELSE 0 END) ISDEBITSE,
        /*CASE WHEN CI.COREBANK='Y' THEN 0 ELSE 1 END */0 ISCOREBANK,/*CASE WHEN CI.COREBANK='Y' THEN 'Yes' ELSE 'No' END*/ 'Yes' ISCOREBANKTEXT,
        NVL(SE.TRADE,0) TRADE, CAMAST.ISINCODE,CA.TRFFEE TRFEEAMT,CI.refcasaacct DDACCTNO, camast.deltd
FROM CASCHD CA, SBSECURITIES SYM, SBSECURITIES EXSYM, ALLCODE A0, ALLCODE A1, CAMAST, AFMAST AF ,
     CFMAST CF , DDMAST CI , AFTYPE TYP, SYSVAR SYS, SEMAST SE,
     (SELECT * FROM CAMASTDTL WHERE DELTD <> 'Y' AND STATUS ='P') CAD
WHERE A0.CDTYPE = 'CA' AND A0.CDNAME = 'CATYPE' AND A0.CDVAL = CAMAST.CATYPE
      AND A1.CDTYPE = 'CA' AND A1.CDNAME = 'CASTATUS' AND A1.CDVAL = CA.STATUS
      AND CA.CAMASTID = CAMAST.CAMASTID AND CAMAST.CODEID = SYM.CODEID
      AND CA.AFACCTNO = AF.ACCTNO AND AF.CUSTID = CF.CUSTID AND AF.ACCTNO=CI.AFACCTNO
      AND CA.DELTD ='N'
      AND CA.STATUS IN ('I','H','K')
      --OLD-AND CA.STATUS IN ('S','G','H','J','W','I','K')
      AND (CA.ISCI ='N' OR(CAMAST.STATUS='K' AND CAMAST.CATYPE ='010')  ) AND CAMAST.STATUS IN ('K','I','H')
      AND SE.ACCTNO(+)=CA.AFACCTNO||CA.CODEID
      AND CA.AMT > 0
      AND CAMAST.CAMASTID = CAD.CAMASTID (+)
      AND CA.ISEXEC='Y'
      AND (CASE WHEN CA.PITRATEMETHOD='##' THEN CAMAST.PITRATEMETHOD ELSE CA.PITRATEMETHOD END) IN ('NO','SC')
      AND AF.ACTYPE = TYP.ACTYPE AND SYS.GRNAME='SYSTEM' AND SYS.VARNAME='CADUTY'
      AND EXSYM.CODEID = (CASE WHEN CAMAST.EXCODEID IS NULL THEN CAMAST.CODEID ELSE CAMAST.EXCODEID END)
/
