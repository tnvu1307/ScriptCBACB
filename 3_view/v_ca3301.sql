SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW V_CA3301
(CAMASTID, CUSTODYCD, ISINCODE, CATYPE, CODEID, 
 EXCODEID, SYMBOL, SYMBOLDIS, STATUS, PARVALUE, 
 EXPARVALUE, PITRATE, REPORTDATE, ACTIONDATE, DESCRIPTION, 
 FULLNAME, IDCODE, ADDRESS, CASTATUS, CIFID, 
 PITRATEMETHOD, TRADEDATE, ISRECEIVE, STATUS_RECEIVED, MCUSTODYCD, 
 MCIFID, BALANCE, RQTTY, PBALANCE, QTTY, 
 AMT, NMQTTY, AQTTY, AAMT, INQTTY, 
 REGISQTTY, SENDQTTY, SENDPBALANCE, SENDRQTTY, SENDAMT, 
 TRADE, TAXAMT, AMTAFTER)
AS 
SELECT VW.CAMASTID,VW.CUSTODYCD,VW.ISINCODE,VW.CATYPE,VW.CODEID,VW.EXCODEID,VW.SYMBOL,VW.SYMBOLDIS,VW.STATUS,VW.PARVALUE,VW.PARVALUE EXPARVALUE,VW.PITRATE,
    VW.REPORTDATE,VW.ACTIONDATE,VW.DESCRIPTION,VW.FULLNAME,VW.IDCODE,VW.ADDRESS,VW.CASTATUS,VW.CIFID,VW.PITRATEMETHOD,VW.TRADEDATE,VW.ISRECEIVE,
    VW.STATUS_RECEIVED, VW.MCUSTODYCD, VW.MCIFID,
    SUM(VW.BALANCE) BALANCE,SUM(VW.RQTTY) RQTTY,SUM(VW.PBALANCE) PBALANCE,SUM(VW.QTTY) QTTY,SUM(VW.AMT) AMT,SUM(VW.NMQTTY) NMQTTY,
    SUM(VW.AQTTY) AQTTY,SUM(VW.AAMT) AAMT,SUM(VW.INQTTY) INQTTY,SUM(VW.REGISQTTY) REGISQTTY,SUM(VW.SENDQTTY) SENDQTTY,SUM(VW.SENDPBALANCE) SENDPBALANCE,
    SUM(VW.SENDRQTTY) SENDRQTTY,SUM(VW.SENDAMT) SENDAMT, SUM(VW.TRADE) TRADE, SUM(VW.TAXAMT) TAXAMT, SUM(VW.AMT - VW.TAXAMT) AMTAFTER
FROM
(
    SELECT CA.AUTOID,CA.TRADE,CA.RQTTY,CA.PBALANCE,CA.AFACCTNO,CA.INQTTY,CA.CODEID,CA.EXCODEID,CAMAST.DESCRIPTION,CF.CUSTODYCD,CF.FULLNAME,CF.IDCODE,CF.ADDRESS,CF.CIFID,CAMAST.STATUS CASTATUS,CAMAST.TRADEDATE,
        SUBSTR(CA.CAMASTID,1,4) || '.' || SUBSTR(CA.CAMASTID,5,6) || '.' ||SUBSTR(CA.CAMASTID,11,6) CAMASTID,CAMAST.ISINCODE,CA.QTTY,CA.AQTTY,CA.NMQTTY,DECODE (CAMAST.CATYPE, '014', 0, 1) ISRIGHTOFF,
        SYM.PARVALUE PARVALUE,EXSYM.PARVALUE EXPARVALUE,SYM.SYMBOL SYMBOLDIS,CAMAST.REPORTDATE REPORTDATE,CAMAST.ACTIONDATE,CAMAST.PITRATE,CAMAST.CATYPE, CA.STATUS, CA.ISRECEIVE, CAMAST.PITRATEMETHOD,
        (CA.SENDPBALANCE + CA.CUTPBALANCE) SENDPBALANCE,(CA.SENDAMT + CA.CUTAMT) SENDAMT,
        CA.AFACCTNO || (CASE WHEN CAMAST.ISWFT = 'Y' THEN (CASE WHEN NVL(CAMAST.TOCODEID,'A') = 'A' THEN (SELECT CODEID FROM SBSECURITIES WHERE REFCODEID = SYM.CODEID) ELSE (SELECT CODEID FROM SBSECURITIES WHERE REFCODEID = SYMTO.CODEID) END) ELSE (CASE WHEN NVL(CAMAST.TOCODEID,'A') = 'A' THEN CAMAST.CODEID ELSE CAMAST.TOCODEID END)END) SEACCTNO,
        CA.AFACCTNO || (CASE WHEN CAMAST.EXCODEID IS NULL THEN CAMAST.CODEID ELSE CAMAST.EXCODEID END) EXSEACCTNO,
        (CASE WHEN CAMAST.CATYPE='014' THEN CA.BALANCE ELSE 0 END) BALANCE,
        (CASE WHEN CAMAST.CATYPE='014' THEN((CA.QTTY + CA.CUTQTTY + CA.SENDQTTY - CA.NMQTTY - CA.INQTTY) * CAMAST.EXPRICE)ELSE 0 END) AAMT,
        (CASE WHEN NVL(CAMAST.TOCODEID,'A') = 'A' THEN SYM.SYMBOL ELSE SYMTO.SYMBOL END ) SYMBOL,
        (CASE WHEN CAMAST.CATYPE IN ('023','014') THEN (CA.QTTY+CA.CUTQTTY+CA.SENDQTTY-CA.INQTTY) ELSE 0 END )REGISQTTY,
        (CASE WHEN CAMAST.CATYPE NOT IN ('005','006','022') THEN (CA.SENDQTTY+CA.CUTQTTY) ELSE 0 END ) SENDQTTY,
        (CASE WHEN CAMAST.CATYPE IN ('005','006','022') THEN (CA.SENDQTTY+CA.CUTQTTY) ELSE 0 END ) SENDRQTTY,
        --(CASE WHEN CAMAST.CATYPE IN ('016') THEN CA.INTAMT ELSE CA.AMT END ) AMT,
         CA.AMT1 AMT,
        (CASE WHEN CF.VAT = 'Y' THEN (
                CASE
                   WHEN TRIM(CAMAST.CATYPE) IN ('016','023','033') THEN ROUND (CA.INTAMT * CAMAST.PITRATE / 100)
                   WHEN CAMAST.CATYPE = '024' THEN ROUND(CA.BALANCE*CAMAST.EXPRICE*CAMAST.PITRATE/100/(TO_NUMBER(SUBSTR(CAMAST.EXRATE ,0,INSTR(CAMAST.EXRATE ,'/') - 1))/TO_NUMBER(SUBSTR(CAMAST.EXRATE ,INSTR(CAMAST.EXRATE ,'/')+1,LENGTH(CAMAST.EXRATE )))))
                   WHEN CAMAST.CATYPE = '010' AND CF.CUSTTYPE ='I' THEN ROUND(NVL(CA.AMT1,0) * CAMAST.PITRATE / 100)
                   WHEN CAMAST.CATYPE = '010' AND CF.CUSTTYPE ='B' THEN 0
                   ELSE ROUND (CA.AMT1 * CAMAST.PITRATE / 100)
                END)
              ELSE 0
         END) TAXAMT,
        (CASE WHEN CAMAST.CATYPE NOT IN ('011','014','017','023','020','021') THEN '' ELSE
            CASE WHEN CA.STATUS IN ('H','I','J','C','W') AND CAMAST.STATUS NOT IN ('I') AND CA.QTTY = 0 THEN 'Nil'
                 WHEN CA.STATUS NOT IN ('C','W') AND CA.ISSE = 'N' THEN 'Not yet received'
                 WHEN CA.STATUS NOT IN ('C','W') AND CA.ISSE = 'Y' THEN 'Segregated'
                 WHEN CA.STATUS = 'W' OR (CA.STATUS = 'C' AND INSTR(CA.PSTATUS,'W') > 0) THEN 'Available'
                 ELSE ''
            END
        END) STATUS_RECEIVED,
        CF.MCUSTODYCD, CF.MCIFID
    FROM SBSECURITIES SYM, SBSECURITIES SYMTO, SBSECURITIES EXSYM, CAMAST ,AFMAST AF, CFMAST CF,
    (
        SELECT CHS.*, NVL(CHD.AMT, CHS.AMT) AMT1
        FROM CASCHD CHS,
        (
            SELECT *
            FROM CASCHDDTL
            WHERE AUTOID IN (
                SELECT MAX(AUTOID) FROM CASCHDDTL WHERE DELTD = 'N' AND STATUS = 'C' GROUP BY AUTOID_CASCHD
            )
        ) CHD
        WHERE CHS.AUTOID = CHD.AUTOID_CASCHD(+)
    ) CA
    WHERE CA.AFACCTNO = AF.ACCTNO
    AND AF.CUSTID = CF.CUSTID
    AND CA.CAMASTID = CAMAST.CAMASTID
    AND CAMAST.CODEID=SYM.CODEID
    AND SYMTO.CODEID = (CASE WHEN NVL(CAMAST.TOCODEID,'A') <> 'A' THEN CAMAST.TOCODEID ELSE CAMAST.CODEID END)
    AND CA.DELTD ='N'
    AND EXSYM.CODEID = (CASE WHEN CAMAST.EXCODEID IS NULL THEN CAMAST.CODEID ELSE CAMAST.EXCODEID END)
) VW
GROUP BY VW.CAMASTID,VW.CUSTODYCD,VW.ISINCODE,VW.CATYPE,VW.CODEID,VW.EXCODEID,VW.SYMBOL,VW.SYMBOLDIS,VW.STATUS,VW.PARVALUE,VW.CIFID,VW.REPORTDATE,VW.REPORTDATE,VW.ACTIONDATE,VW.DESCRIPTION,VW.FULLNAME,
VW.IDCODE,VW.ADDRESS,VW.CASTATUS,VW.PITRATEMETHOD,VW.TRADEDATE,VW.PITRATE,VW.ISRECEIVE, VW.STATUS_RECEIVED, VW.MCUSTODYCD, VW.MCIFID
/
