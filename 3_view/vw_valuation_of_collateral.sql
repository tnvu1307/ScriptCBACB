SET DEFINE OFF;
CREATE OR REPLACE FORCE VIEW VW_VALUATION_OF_COLLATERAL
(ISSUERID, FULLNAME, ACTYPE, BONDSYMBOL, ISSUECODE, 
 SYMBOL, SECTYPE, SECTYPECNT, VALMETHOD, VALMETHODCNT, 
 VALUATIONDATE, VALUATIONPRICE, VBMA, REUTERS, FORMULA, 
 NOTE)
AS 
SELECT DISTINCT
        T."ISSUERID",
        T."FULLNAME",
        T."ACTYPE",
   --     T."BONDCODE",
        T."BONDSYMBOL",
        T."ISSUECODE",
        T."SYMBOL",
        T."SECTYPE",
        T."SECTYPECNT",
        T."VALMETHOD",
        T."VALMETHODCNT",
        BF.TXDATE VALUATIONDATE,
        BF.BONDPRICE VALUATIONPRICE,
        BF.VBMA VBMA,
        BF.REUTERS REUTERS,
        BF.INTERPOLATION FORMULA,
        BF.NOTE NOTE
FROM (
        SELECT *
        FROM BONDINFO
        WHERE ( TXDATE)
        IN (SELECT  MAX(TXDATE) FROM BONDINFO)
     )BF,
                (
                SELECT ISS.ISSUERID, ISS.FULLNAME,ES.ISSUECODE,
                       BO.ACTYPE,BIS.BONDCODE, TAG.BONDSYMBOL,
                       BO.SYMBOL,
                       BO.SECTYPE, A1.EN_CDCONTENT SECTYPECNT, BO.SECTYPE||'|'||BO.VALMETHOD AS VALMETHOD,
                       CASE
                         WHEN BO.SECTYPE IN ('111')
                              THEN (SELECT A2.EN_CDCONTENT FROM ALLCODE A2 WHERE A2.CDTYPE = 'BA' AND A2.CDNAME = 'STOCKMETHOD' AND BO.VALMETHOD = A2.CDVAL)
                         WHEN BO.SECTYPE IN ('555')
                               THEN (SELECT A2.EN_CDCONTENT FROM ALLCODE A2 WHERE A2.CDTYPE = 'BA' AND A2.CDNAME = 'CASHMETHOD' AND BO.VALMETHOD = A2.CDVAL)
                         ELSE
                              (SELECT A2.EN_CDCONTENT FROM ALLCODE A2 WHERE A2.CDTYPE = 'BA' AND A2.CDNAME = 'BONDMETHOD' AND BO.VALMETHOD = A2.CDVAL)
                       END VALMETHODCNT
                FROM (
                          SELECT DISTINCT TRIM(REGEXP_SUBSTR(BO.TICKERLIST,'[^,]+', 1, LEVEL)) SYMBOL,
                          BO.ACTYPE, BO.SECTYPE, BO.VALMETHOD, BO.ISSUESID, BO.XPARAM
                          FROM BONDTYPE BO
                          CONNECT BY REGEXP_SUBSTR(BO.TICKERLIST, '[^,]+', 1, LEVEL) IS NOT NULL
                    ) BO,
                    BONDISSUE BIS,ISSUES ES, SBSECURITIES SB, ALLCODE A1, ISSUERS ISS,
                    (
                    SELECT T.AUTOID, T.ISSUERID,T.ISSUECODE,LISTAGG(T.BONDSYMBOL, ', ') WITHIN GROUP (ORDER BY T.AUTOID, T.ISSUERID,T.ISSUECODE) BONDSYMBOL
                    FROM (
                            SELECT DISTINCT ISS.AUTOID, ISS.ISSUERID,ISS.ISSUECODE,BI.BONDSYMBOL
                            FROM ISSUES ISS LEFT JOIN BONDISSUE BI ON ISS.AUTOID = BI.ISSUESID
                            GROUP BY ISS.AUTOID, ISS.ISSUERID,ISS.ISSUECODE,BI.BONDSYMBOL
                         ) T
                    GROUP BY T.AUTOID, T.ISSUERID,T.ISSUECODE
                    )TAG
                WHERE --BIS.BONDTYPE = '001' AND
                          SB.CODEID = BIS.BONDCODE
                      AND BIS.ISSUESID = BO.ISSUESID
                      AND A1.CDTYPE = 'SA' AND A1.CDNAME = 'SECTYPE' AND A1.CDVAL = BO.SECTYPE
                      AND ISS.ISSUERID = SB.ISSUERID
                      AND TAG.AUTOID=BIS.ISSUESID
                      AND BIS.ISSUESID= ES.AUTOID(+)
                ) T
WHERE BF.BONDACTYPE = T.ACTYPE
      AND BF.SYMBOL = T.SYMBOL
ORDER BY BONDSYMBOL, BF.TXDATE, T.SYMBOL
/
