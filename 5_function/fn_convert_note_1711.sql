SET DEFINE OFF;
CREATE OR REPLACE FUNCTION fn_convert_note_1711 (PV_STRING IN VARCHAR2, PV_MSTYPE IN VARCHAR2) RETURN VARCHAR2 IS
    L_OUT_STRING VARCHAR2(2000);
    L_COUNT NUMBER;
    L_I NUMBER;
    L_MAX NUMBER;
BEGIN
    L_OUT_STRING := FN_VSDBREAKSTRING_1711(PV_STRING);
    L_I := 0;

    SELECT (CASE WHEN PV_MSTYPE = '568' THEN 10 ELSE 35 END) INTO L_MAX FROM DUAL;

    SELECT REGEXP_COUNT(L_OUT_STRING, CHR(10)) INTO L_COUNT FROM DUAL;

    IF L_COUNT > L_MAX THEN
        FOR I IN 0..L_MAX LOOP
            IF I = 0 THEN
                SELECT INSTR(L_OUT_STRING, CHR(10), L_I) INTO L_I FROM DUAL;
            ELSE
                SELECT INSTR(L_OUT_STRING, CHR(10), L_I + 1) INTO L_I FROM DUAL;
            END IF;
        END LOOP;
        L_OUT_STRING := SUBSTR(L_OUT_STRING, 0, L_I - 1);
    END IF;

    RETURN L_OUT_STRING;
EXCEPTION WHEN OTHERS THEN
    RETURN PV_STRING;
END;
/
