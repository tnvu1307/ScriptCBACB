SET DEFINE OFF;
CREATE OR REPLACE FUNCTION fn_compare_two_substr(P_ISSUESID IN VARCHAR2, P_TICKERLIST IN VARCHAR2, P_ACTYPE IN VARCHAR2)
RETURN NUMBER
IS
    --NAM.LY - 21/02/2020
    V_ISSUESID      NUMBER;
    V_BOTICKER      VARCHAR2(100 BYTE);
    V_CHECK         NUMBER := 0;
    V_CHECKSUM      NUMBER := 0;
    V_TICKERLIST    VARCHAR2(2000 BYTE);
    V_ACTYPE        NUMBER;
BEGIN
    V_ISSUESID   := TO_NUMBER(P_ISSUESID);
    V_ACTYPE     := TO_NUMBER(P_ACTYPE);
    V_TICKERLIST := P_TICKERLIST;
    V_CHECKSUM := 0;
    V_CHECK    := 0;
    FOR L IN (
                SELECT DISTINCT TRIM(REGEXP_SUBSTR(BO.TICKERLIST,'[^,]+', 1, LEVEL)) BOTICKER
                FROM BONDTYPE BO
                WHERE BO.ISSUESID = V_ISSUESID AND BO.ACTYPE <> V_ACTYPE
                CONNECT BY REGEXP_SUBSTR(BO.TICKERLIST, '[^,]+', 1, LEVEL) IS NOT NULL
              )
    LOOP
        V_BOTICKER := L.BOTICKER;
        BEGIN
            SELECT COUNT(*) INTO V_CHECK
            FROM DUAL
            WHERE regexp_like(V_TICKERLIST, '(^|\s|\W)'||V_BOTICKER||'($|\s|\W)');
            EXCEPTION
            WHEN OTHERS THEN V_CHECK := 0;
        END;
        V_CHECKSUM := V_CHECKSUM + V_CHECK;
    END LOOP;
    RETURN V_CHECKSUM;
END;
/
