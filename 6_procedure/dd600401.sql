SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE dd600401(
      PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   F_DATE                 IN       VARCHAR2, /*TU NGAY */
   T_DATE                 IN       VARCHAR2, /*DEN NGAY */
   P_GCBCODE              IN       VARCHAR2, /*Ma GCB */
   P_AMCCODE              IN       VARCHAR2, /*MA AMC */
   P_CUSTODYCD            IN       VARCHAR2
   )
IS
    -- REPORT ON THE DAY BECOME/IS NO LONGER MAJOR SHAREHOLDER, INVESTORS HOLDING 5% OR MORE OF SHARES
    -- PERSON      DATE                 COMMENTS
    -- ---------   ------               -------------------------------------------
    -- DU.PHAN    23-10-2019           CREATED
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

    V_FROMDATE          DATE;
    V_TODATE            DATE;
    V_CURRDATE          DATE;
    V_NEXTDATE          DATE;
    V_PREVDATE          DATE;
    V_DUEDATE           VARCHAR2 (10);
    V_GCBID             VARCHAR2 (100);
    V_AMCID             VARCHAR2 (100);
    V_CUSTODYCD         VARCHAR2 (100);
BEGIN
     V_STROPTION := OPT;
     V_CURRDATE   := GETCURRDATE;--TO_DATE(TO_CHAR(GETCURRDATE,'MM/RRRR'),'MM/RRRR');
     IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
     ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
     ELSE
        V_STRBRID:=BRID;
     END IF;

    V_FROMDATE  := TO_DATE(F_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    V_TODATE    := TO_DATE(T_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    V_PREVDATE  := FN_GET_PREVDATE(V_FROMDATE,1);
    V_NEXTDATE  := FN_GET_NEXTDATE(V_FROMDATE,1);
    V_CUSTODYCD := NVL(TRIM(P_CUSTODYCD),'%%');

    BEGIN
        IF UPPER(P_GCBCODE) = 'ALL' THEN
            V_GCBID:='%';
        ELSE
            SELECT FA.AUTOID
            INTO V_GCBID
            FROM FAMEMBERS FA
            WHERE ROLES='GCB' AND UPPER(FA.SHORTNAME) = UPPER(P_GCBCODE);
        END IF;
    EXCEPTION WHEN OTHERS THEN
        V_GCBID:='';
    END;

    BEGIN
        IF UPPER(P_AMCCODE) = 'ALL' THEN
            V_AMCID:='%';
        ELSE
            SELECT FA.AUTOID
            INTO V_AMCID
            FROM FAMEMBERS FA
            WHERE ROLES='AMC' AND  UPPER(FA.SHORTNAME) =  UPPER(P_AMCCODE);
        END IF;
    EXCEPTION WHEN OTHERS THEN
        V_AMCID:='';
    END;

    BEGIN
        WITH TMPFEETRAN AS (
            SELECT ADD_MONTHS(TXDATE,1) TXDATE
            FROM FEETRAN FT
            WHERE TYPE='F' AND STATUS='N' AND TXDATE <=V_TODATE AND TXDATE >=V_FROMDATE AND TXDATE<=V_TODATE
            ORDER BY TXDATE DESC
        )
        SELECT TO_CHAR(TXDATE,'MM/YYYY')
        INTO V_DUEDATE
        FROM TMPFEETRAN
        WHERE ROWNUM=1
        ORDER BY 1;
    EXCEPTION WHEN OTHERS THEN
        V_DUEDATE:='';
    END;

OPEN PV_REFCURSOR FOR

SELECT A.*,
      (
            CASE WHEN A.FMONTH >= 12 THEN 'Over due for ' ||
                    TO_CHAR(FLOOR(A.FMONTH / 12)) || (CASE WHEN FLOOR(A.FMONTH / 12) >= 2 THEN ' years ' else ' year ' end) ||
                    (CASE WHEN (A.FMONTH - (FLOOR(A.FMONTH / 12) * 12)) > 0 THEN
                            TO_CHAR(A.FMONTH - (FLOOR(A.FMONTH / 12) * 12)) || (CASE WHEN A.FMONTH - (FLOOR(A.FMONTH / 12) * 12) >= 2 THEN ', months' else ', month' end)
                          ELSE '' END
                    )
                 WHEN A.FMONTH >= 1 AND A.FMONTH < 12 THEN 'Over due for ' || TO_CHAR(A.FMONTH) || (CASE WHEN A.FMONTH >= 2 THEN ' months' else ' month' end)
                 ELSE ''
            END

      ) CREMARK
FROM
(
    SELECT FAAMC,NVL(AUTOID,0) AUTOID,V_DUEDATE DUEDATE,CIFID,FULLNAME,CUSTODYCD,FTMONTH,FTNEXTMONTH,STC,SUM(FEEAMT)FEEAMT,SUBSTR(FTMONTH,0,2) MM,SUBSTR(FTMONTH,4,4) RRRR,CURRENCY,MAX(MCIFID) MCIFID, FMONTH
    FROM (
        SELECT (CASE WHEN FA.SHORTNAME IS NULL THEN CF.FULLNAME ELSE FA.SHORTNAME || ' AMC' END) || DECODE(FEE.CURRENCY,'USD',' ','') FAAMC,
            CF.CIFID,CF.FULLNAME,CF.CUSTODYCD,DECODE(CF.COUNTRY,'234',SUBSTR(CF.CUSTODYCD,5),CF.TRADINGCODE) STC,
            TO_CHAR(FEE.TXDATE, 'MM/YYYY') FTMONTH, TO_DATE('20' || TO_CHAR(ADD_MONTHS(FEE.TXDATE,1), '/MM/RRRR'),'DD/MM/RRRR') FTNEXTMONTH,
            FLOOR(MONTHS_BETWEEN(V_CURRDATE, TO_DATE('20' || TO_CHAR(ADD_MONTHS(FEE.TXDATE,1),'/MM/RRRR'),'DD/MM/RRRR'))) FMONTH,
            FA.AUTOID,FEE.CURRENCY,NVL(FEE.FEEAMOUNT,0) + NVL(FEE.TAXAMOUNT,0) FEEAMT,
            CF.MCIFID
        FROM CFMAST CF,
        (
            SELECT * FROM FEE_BOOKING_RESULT
            UNION ALL
            SELECT * FROM FEE_BOOKING_RESULTHIST
        ) FEE,
        (SELECT * FROM ALLCODE WHERE CDTYPE = 'DD' AND CDNAME = 'FSTATUS') AL,
        (SELECT * FROM ALLCODE WHERE CDTYPE = 'DD' AND CDNAME = 'DELTDTEXT') A2,
        (SELECT * FROM FAMEMBERS WHERE ROLES = 'AMC') FA
        WHERE CF.SUPEBANK = 'N'
        AND FEE.STATUS = 'C'
        AND FEE.DELTD = 'N'
        AND NVL(TO_CHAR(CF.AMCID),'%%') LIKE V_AMCID
        AND NVL(TO_CHAR(CF.GCBID),'%%') LIKE V_GCBID
        AND CF.AMCID = FA.AUTOID (+)
        AND FEE.TXDATE >= V_FROMDATE AND FEE.TXDATE <= V_TODATE
        AND FEE.DELTD = A2.CDVAL(+)
        AND CF.CIFID = FEE.CIFID(+)
        AND FEE.STATUS = AL.CDVAL(+)

        UNION ALL

        SELECT (CASE WHEN FA.SHORTNAME IS NULL THEN CF.FULLNAME ELSE FA.SHORTNAME || ' AMC' END) || ' ' FAAMC,
            CF.CIFID, CF.FULLNAME,CF.CUSTODYCD,DECODE(CF.COUNTRY,'234',SUBSTR(CF.CUSTODYCD,5),CF.TRADINGCODE) STC
            ,BILLING_MONTH FTMONTH, TO_DATE('20' || TO_CHAR(ADD_MONTHS(TO_DATE(BILLING_MONTH, '/MM/RRRR'),1), '/MM/RRRR'),'DD/MM/RRRR') FTNEXTMONTH,
            FEE.FMONTH,
            FA.AUTOID,'USD' CURRENCY
            ,SUM(NVL(FEE.TOTAL_FEE_AMOUNT,0)) FEEAMT, MAX(CF.MCIFID) MCIFID --TRUNG.LUU: 19-02-2021 SHBVNEX-2067 LAY MASTER CIFID
        FROM CFMAST CF,
        (
            SELECT FE.*,
                   FLOOR(MONTHS_BETWEEN(V_CURRDATE, ADD_MONTHS(TO_DATE(BILLING_MONTH, 'DD/MM/RRRR'),1))) FMONTH
            FROM TBL_SHV_FEE_COLLECTION FE
        ) FEE,
        (SELECT * FROM FAMEMBERS WHERE ROLES ='AMC') FA
        WHERE CF.CIFID = FEE.PORTFOLIO_NO
        AND CF.SUPEBANK ='N'
        AND NVL(TO_CHAR(CF.AMCID),'%%') LIKE V_AMCID
        AND NVL(TO_CHAR(CF.GCBID),'%%') LIKE V_GCBID
        AND CF.AMCID = FA.AUTOID (+)
        AND FEE.REALCOLLECTION = 'PENDING'
        AND FEE.AITHER_BOOKING >= V_FROMDATE AND FEE.AITHER_BOOKING <= V_TODATE
        GROUP BY CF.CIFID, CF.FULLNAME, CF.CUSTODYCD, DECODE(CF.COUNTRY,'234',SUBSTR(CF.CUSTODYCD,5),CF.TRADINGCODE), BILLING_MONTH, FA.AUTOID, FA.FULLNAME, FA.SHORTNAME, FEE.FMONTH
    )
    WHERE CUSTODYCD LIKE V_CUSTODYCD
    GROUP BY CIFID,FULLNAME,CUSTODYCD,FTMONTH,FTNEXTMONTH,STC,AUTOID,FAAMC,CURRENCY,FMONTH
)A
ORDER BY A.FAAMC, A.FTNEXTMONTH
;
EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('DD600401: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;
/
