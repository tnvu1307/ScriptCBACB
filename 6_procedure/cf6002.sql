SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE cf6002 (
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   --F_DATE                 IN       VARCHAR2, /*TU NGAY */
   --T_DATE                 IN       VARCHAR2, /*DEN NGAY */
   PV_CUSTODYCD           IN       VARCHAR2, /*SO TK LUU KY */
   P_DOCTYPES           IN       VARCHAR2 /*SO TK LUU KY */
   )
IS
    -- GIAY DANG KY MA SO GIAO DICH
    -- PERSON      DATE                 COMMENTS
    -- ---------   ------               -------------------------------------------
    -- TRUONGLD    18-10-2019           CREATED
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

    V_FROMDATE     DATE;
    V_TODATE       DATE;
    V_CURRDATE     DATE;
    V_CUSTODYCD    VARCHAR2(20);
    V_HEADOFFICE   VARCHAR2(500);
BEGIN

   V_STROPTION := OPT;

   V_CURRDATE   := GETCURRDATE;

    IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
    ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
    ELSE
        V_STRBRID:=BRID;
    END IF;

    V_CUSTODYCD := REPLACE(PV_CUSTODYCD,'.','');

    /*
    V_FROMDATE  :=     TO_DATE(F_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    V_TODATE    :=     TO_DATE(T_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    */

OPEN PV_REFCURSOR FOR
    SELECT (CASE WHEN COUNTRY ='234' THEN SUBSTR(CF.CUSTODYCD,5,6) ELSE TRADINGCODE END) CUSTODYCD, -- SO TK LUU KY
           CF.FULLNAME, -- TEN KH
           P_DOCTYPES DOCTYPES,
           NVL(FA.FULLNAME,'NULL') TRTNAME,
           NVL(FA1.FULLNAME,'NULL') AMCNAME,
           GETCURRDATE CURRDATE
    FROM CFMAST CF,(SELECT * FROM FAMEMBERS WHERE ROLES='TRU') FA,(SELECT * FROM FAMEMBERS WHERE ROLES='AMC') FA1
    WHERE CF.CUSTODYCD = V_CUSTODYCD
    AND CF.TRUSTEEID = FA.AUTOID (+)
    AND CF.AMCID = FA1.AUTOID (+);
EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('CF6002: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;
/
