SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE ba6030 (
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   IDATE       IN DATE,
   PV_TCPH   IN       VARCHAR2,
   PV_SYMBOL      IN       VARCHAR2
)
IS

   V_SYMBOL     VARCHAR2 (20);
   V_CUSTODYCD  VARCHAR2 (30);

    V_IDATE DATE;
   V_STROPTION         VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID           VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

BEGIN

    V_STROPTION := OPT;
    IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
    ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
    ELSE
        V_STRBRID:= BRID;
    END IF;
--------------------------------------------

         V_CUSTODYCD := REPLACE(PV_TCPH,'.','');

--------------------------------------------

         V_SYMBOL := PV_SYMBOL;

 --------------------------------------------
        V_IDATE    :=     TO_DATE(IDATE, SYSTEMNUMS.C_DATE_FORMAT);

 OPEN PV_REFCURSOR
 FOR
            SELECT ISR.FULLNAME ISRNAME
                ,V_IDATE RPTDATE
                ,ISR2.FULLNAME
                ,SB.SYMBOL
                ,SB.CONTRACTNO
                ,SB.CONTRACTDATE
                ,SB.PARVALUE/1000000000 BILVALUE
                ,UTILS.so_thanh_chu(SB.PARVALUE)    PARVALUE
                ,SB.ISSUEDATE
                ,SB.EXPDATE
                ,A0.CDCONTENT PERIODINTEREST
                ,SE.MORTAGE
                ,'NULL' STRPARVALUE
                ,CF.CUSTODYCD
        FROM
        (SELECT BO.TICKERLIST,ISS.ISSUERID
        FROM BONDTYPE BO, ISSUES ISS
        WHERE BO.ISSUESID = ISS.AUTOID AND BO.SECTYPE='555') BSE,
        (SELECT * FROM SBSECURITIES WHERE SECTYPE='009' AND TRADEPLACE <> '006' AND SYMBOL=V_SYMBOL) SB,ISSUERS ISR,ISSUERS ISR2,ALLCODE A0
        ,CFMAST CF, AFMAST AF, SEMAST SE,
        (
        SELECT SE.ACCTNO SEACCTNO, OD.EXECTYPE,
               DECODE(OD.EXECTYPE,'NB',SUM(ETF.QTTY),0) CKCC_RECEIVING,
               DECODE(OD.EXECTYPE,'NS',SUM(ETF.QTTY),0) CKCC_NETTING
        FROM ETFWSAP ETF, ODMAST OD, SEMAST SE
        WHERE ETF.ORDERID = OD.ORDERID AND
              OD.ODTYPE = 'SWE' AND
              OD.DELTD <> 'Y' AND
              ETF.AFACCTNO = SE.AFACCTNO AND ETF.CODEID = SE.CODEID
        GROUP BY SE.ACCTNO, OD.EXECTYPE
    ) ETF,
    V_GETBUYORDERINFO_BY_SYMBOL REFORDER_BUY
        WHERE  SB.SYMBOL=BSE.TICKERLIST AND SB.ISSUERID=ISR.ISSUERID AND BSE.ISSUERID=ISR2.ISSUERID
        AND CF.CUSTID=AF.CUSTID AND AF.ACCTNO=SE.AFACCTNO AND SE.CODEID=SB.CODEID
        AND A0.CDNAME='PERIODINTEREST' AND A0.CDTYPE='CB' AND A0.CDVAL=SB.PERIODINTEREST
        AND ISR2.SHORTNAME=V_CUSTODYCD
        AND SE.ACCTNO=REFORDER_BUY.SEACCTNO (+)
        AND SE.ACCTNO=ETF.SEACCTNO (+)
        AND (SE.TRADE+SE.HOLD+SE.MORTAGE+SE.NETTING+SE.BLOCKED+SE.WITHDRAW+SE.BLOCKWITHDRAW+SE.EMKQTTY > 0
        OR SE.RECEIVING - NVL(REFORDER_BUY.SERECEIVING,0) - NVL(ETF.CKCC_RECEIVING,0) > 0
        OR SE.TEMP >0
        OR ETF.CKCC_RECEIVING>0);
        --AND CF.CUSTODYCD=V_CUSTODYCD;
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/
