SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE GL0006 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   BANKCODE       IN       VARCHAR2,
   CCYCD          IN       VARCHAR2
)
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
--  SO QUY TIEN MAT
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   21-NOV-06  CREATED
-- ---------   ------  -------------------------------------------
 V_STROPTION          VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
 V_STRBRID            VARCHAR2 (4);
 BE_BALANCE          NUMBER (20, 2);
 V_CUSTID             VARCHAR2 (20);
 V_PERIOD             VARCHAR2 (4);
 V_PCUR             PKG_REPORT.REF_CURSOR;
 DMIN         DATE ;
 V_STRACCTNO            VARCHAR2 (20);
             -- USED WHEN V_NUMOPTION > 0
  -- V_STRLEVELG        VARCHAR2 (10);

-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE
BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;
   CASE
   WHEN BANKCODE='222' THEN V_CUSTID:='0001445566'  ;
     WHEN BANKCODE='010' THEN V_CUSTID:='0001999999'  ;
     WHEN BANKCODE='020' THEN V_CUSTID:='0001000559' ;
     WHEN BANKCODE='030' THEN V_CUSTID:='0001000712';
     WHEN BANKCODE='040' THEN V_CUSTID:='0001000262' ;
     WHEN BANKCODE='050' THEN V_CUSTID:='0001000288' ;
     WHEN BANKCODE='060' THEN V_CUSTID:='0001001681';
     WHEN BANKCODE='070' THEN V_CUSTID:='0001004891';
     WHEN BANKCODE='080' THEN V_CUSTID:='0001000713' ;
     WHEN BANKCODE='090' THEN V_CUSTID:='0001003414' ;
     WHEN BANKCODE='011' THEN V_CUSTID:='0001004795' ;
     WHEN BANKCODE='012' THEN V_CUSTID:='0001004891' ;
     WHEN BANKCODE='013' THEN V_CUSTID:='0001005073' ;
     WHEN BANKCODE='014' THEN V_CUSTID:='0001006727';
     WHEN BANKCODE='015' THEN V_CUSTID:='0001005496';
     WHEN BANKCODE='016' THEN V_CUSTID:='0001009979';
     WHEN BANKCODE='017' THEN V_CUSTID:='0001009991';
     WHEN BANKCODE='018' THEN V_CUSTID:='0001010021';
     WHEN BANKCODE='019' THEN V_CUSTID:='0001005257';
     WHEN BANKCODE='021' THEN V_CUSTID:='0001008895';
     WHEN BANKCODE='022' THEN V_CUSTID:='0001010078';
     WHEN BANKCODE='023' THEN V_CUSTID:='0001010079';
     WHEN BANKCODE='024' THEN V_CUSTID:='0001010080';
     WHEN BANKCODE='025' THEN V_CUSTID:='0001006532';
     WHEN BANKCODE='026' THEN V_CUSTID:='0001010085';
     WHEN BANKCODE='027' THEN V_CUSTID:='0001010122';
     WHEN BANKCODE='028' THEN V_CUSTID:='0001010123';
     WHEN BANKCODE='029' THEN V_CUSTID:='0001005497';
     WHEN BANKCODE='031' THEN V_CUSTID:='0001010190';
     WHEN BANKCODE='032' THEN V_CUSTID:='0001010233';
     WHEN BANKCODE='033' THEN V_CUSTID:='0001010603';
     WHEN BANKCODE='034' THEN V_CUSTID:='0001010733';
     WHEN BANKCODE='035' THEN V_CUSTID:='0001010792';
     WHEN BANKCODE='036' THEN V_CUSTID:='0001006331';
     WHEN BANKCODE='037' THEN V_CUSTID:='0001011207';
     WHEN BANKCODE='038' THEN V_CUSTID:='0001011389';
     WHEN BANKCODE='039' THEN V_CUSTID:='0001011406';
     WHEN BANKCODE='041' THEN V_CUSTID:='0001011440';
     WHEN BANKCODE='042' THEN V_CUSTID:='0001011801';
     WHEN BANKCODE='043' THEN V_CUSTID:='0001011732';
     WHEN BANKCODE='044' THEN V_CUSTID:='0001011980';
     WHEN BANKCODE='045' THEN V_CUSTID:='0001012523';
     WHEN BANKCODE='046' THEN V_CUSTID:='0001013399';

     WHEN BANKCODE='049' THEN V_CUSTID:='0101003530';
     WHEN BANKCODE='051' THEN V_CUSTID:='0001012283';
     WHEN BANKCODE='052' THEN V_CUSTID:='0001013637';
      
     WHEN BANKCODE='110' THEN V_CUSTID:='0101000264' ;
     WHEN BANKCODE='120' THEN V_CUSTID:='0101000265' ;
     WHEN BANKCODE='130' THEN V_CUSTID:='0101000266' ;
     WHEN BANKCODE='140' THEN V_CUSTID:='0101000267' ;
     WHEN BANKCODE='150' THEN V_CUSTID:='0101000268';
     WHEN BANKCODE='160' THEN V_CUSTID:='0101000269' ;
     WHEN BANKCODE='170' THEN V_CUSTID:='0101000270';
     WHEN BANKCODE='180' THEN V_CUSTID:='0101000740';
     WHEN BANKCODE='190' THEN V_CUSTID:='0101000741';
     WHEN BANKCODE='111' THEN V_CUSTID:='0101001249';
     WHEN BANKCODE='112' THEN V_CUSTID:='0101001250';
     WHEN BANKCODE='113' THEN V_CUSTID:='0101001520';
     WHEN BANKCODE='114' THEN V_CUSTID:='0101001865';
     WHEN BANKCODE='115' THEN V_CUSTID:='0101001868';
     WHEN BANKCODE='116' THEN V_CUSTID:='0101002128';
     WHEN BANKCODE='117' THEN V_CUSTID:='0101002291';
     WHEN BANKCODE='118' THEN V_CUSTID:='0101002520';
     WHEN BANKCODE='119' THEN V_CUSTID:='0101003269';

    END CASE;
      CASE
     WHEN BANKCODE='010' THEN  V_STRACCTNO :='000100112101000';
     WHEN BANKCODE='020' THEN  V_STRACCTNO :='000100112102000';
     WHEN BANKCODE='030' THEN  V_STRACCTNO :='000100112103000';
     WHEN BANKCODE='040' THEN  V_STRACCTNO :='000100112104000';
     WHEN BANKCODE='050' THEN  V_STRACCTNO :='000100112105000';
     WHEN BANKCODE='060' THEN  V_STRACCTNO :='000100112106000';
     WHEN BANKCODE='070' THEN  V_STRACCTNO:='000100112104020';
     WHEN BANKCODE='080' THEN  V_STRACCTNO :='000100112108000';
     WHEN BANKCODE='090' THEN  V_STRACCTNO :='000100112109000';
     WHEN BANKCODE='011' THEN  V_STRACCTNO :='000100112104010';
     WHEN BANKCODE='012' THEN  V_STRACCTNO :='000100112104020';
     WHEN BANKCODE='013' THEN  V_STRACCTNO :='000100112103010';
     WHEN BANKCODE='014' THEN  V_STRACCTNO :='000100112102010';
     WHEN BANKCODE='015' THEN  V_STRACCTNO :='000100112118000';
     WHEN BANKCODE='016' THEN  V_STRACCTNO :='000100112109001';
     WHEN BANKCODE='017' THEN  V_STRACCTNO :='000100112109002';
     WHEN BANKCODE='018' THEN  V_STRACCTNO :='000100112109003';
     WHEN BANKCODE='019' THEN  V_STRACCTNO :='000100112109004';
     WHEN BANKCODE='021' THEN  V_STRACCTNO :='000100112107100';
     WHEN BANKCODE='022' THEN  V_STRACCTNO :='000100112109005';
     WHEN BANKCODE='023' THEN  V_STRACCTNO :='000100112109006';
     WHEN BANKCODE='024' THEN  V_STRACCTNO :='000100112109007';
     WHEN BANKCODE='025' THEN  V_STRACCTNO :='000100112109008';
     WHEN BANKCODE='026' THEN  V_STRACCTNO :='000100112109009';
     WHEN BANKCODE='027' THEN  V_STRACCTNO :='000100112109010';
     WHEN BANKCODE='028' THEN  V_STRACCTNO :='000100112109011';
     WHEN BANKCODE='029' THEN  V_STRACCTNO :='000100112109012';
     WHEN BANKCODE='031' THEN  V_STRACCTNO :='000100112109015';
     WHEN BANKCODE='032' THEN  V_STRACCTNO :='000100112109016';
     WHEN BANKCODE='033' THEN  V_STRACCTNO :='000100112109017';
     WHEN BANKCODE='034' THEN  V_STRACCTNO :='000100112109018';
     WHEN BANKCODE='035' THEN  V_STRACCTNO :='000100112104030';
     WHEN BANKCODE='036' THEN  V_STRACCTNO :='000100112109019';
     WHEN BANKCODE='037' THEN  V_STRACCTNO :='000100112109020';
     WHEN BANKCODE='038' THEN  V_STRACCTNO :='000100112109021';
     WHEN BANKCODE='039' THEN  V_STRACCTNO :='000100112109022';
     WHEN BANKCODE='041' THEN  V_STRACCTNO :='000100112109023';
     WHEN BANKCODE='042' THEN  V_STRACCTNO :='000100112109025';
     WHEN BANKCODE='043' THEN  V_STRACCTNO :='000100112109024';
     WHEN BANKCODE='044' THEN  V_STRACCTNO :='000100112109026';
     WHEN BANKCODE='045' THEN  V_STRACCTNO :='000100112109028';
     WHEN BANKCODE='046' THEN  V_STRACCTNO :='000100112109029';

     WHEN BANKCODE='049' THEN  V_STRACCTNO :='010100112119017';
     WHEN BANKCODE='051' THEN  V_STRACCTNO :='000100112109027';
     WHEN BANKCODE='052' THEN  V_STRACCTNO :='000100112109030';


     WHEN BANKCODE='110' THEN  V_STRACCTNO :='010100112111000';
     WHEN BANKCODE='120' THEN  V_STRACCTNO :='010100112111010';
     WHEN BANKCODE='130' THEN  V_STRACCTNO :='010100112112000';
     WHEN BANKCODE='140' THEN  V_STRACCTNO :='010100112113000';
     WHEN BANKCODE='150' THEN  V_STRACCTNO :='010100112113010';
     WHEN BANKCODE='160' THEN  V_STRACCTNO :='010100112114000';
     WHEN BANKCODE='170' THEN  V_STRACCTNO :='010100112114010';
     WHEN BANKCODE='180' THEN  V_STRACCTNO :='010100112116000';
     WHEN BANKCODE='190' THEN  V_STRACCTNO :='010100112117000';
     WHEN BANKCODE='111' THEN  V_STRACCTNO :='010100112119000';
     WHEN BANKCODE='112' THEN  V_STRACCTNO :='010100112119010';
     WHEN BANKCODE='113' THEN  V_STRACCTNO :='010100112115000';
     WHEN BANKCODE='114' THEN  V_STRACCTNO :='010100112119013';
     WHEN BANKCODE='115' THEN  V_STRACCTNO :='010100112119014';
     WHEN BANKCODE='116' THEN  V_STRACCTNO :='010100112119015';
     WHEN BANKCODE='117' THEN  V_STRACCTNO :='010100112118000';
     WHEN BANKCODE='118' THEN  V_STRACCTNO :='010100112119016';
     WHEN BANKCODE='119' THEN  V_STRACCTNO :='010100112119018';
     WHEN BANKCODE='222' THEN  V_STRACCTNO :='000100112102222';
    END CASE;


   -- GET REPORT'S PARAMETERS

   -- END OF GETTING REPORT'S PARAMETERS
--NGAY NHO NHAT TRONG GL HIST
OPEN V_PCUR
  FOR
  SELECT MIN(TXDATE)
  FROM GLHIST;
  LOOP
      FETCH V_PCUR
       INTO DMIN ;
       EXIT WHEN V_PCUR%NOTFOUND;
  END LOOP;
CLOSE V_PCUR;

-- LOAI NGAY F_DATE

IF DMIN > TO_DATE(F_DATE ,'DD/MM/YYYY')-1 THEN
     BE_BALANCE:=0;

  ELSE
    OPEN V_PCUR
     FOR
     
/******************************************************************************
 Purpose: tuning GL006
 Modification date: 24/07/2009
 Modifier: LuongT
 ****************************************************************************/
/*
SELECT (SUM(CRAMT)-SUM (DRAMT))  BE_BALANCE
from (
SELECT GL.ACCTNO,GL.BUSDATE,GL.TXNUM,GL.TXDESC, GL.DRAMT DRAMT, GL.CRAMT CRAMT,MI.CUSTID
FROM
(SELECT GL.TXDATE, GL.TXNUM, TL.TXDESC ,(CASE WHEN DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN DORC='C' THEN GL.AMT ELSE 0 END) CRAMT,GL.DORC,GL.SUBTXNO,GL.ACCTNO,TL.BUSDATE
     FROM GLTRAN GL ,TLLOG TL
     WHERE  TL.TXNUM =GL.TXNUM AND TL.TXDATE =GL.TXDATE AND GL.DELTD <>'Y'
     AND TL.BUSDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')

 UNION ALL

 SELECT GL.TXDATE, GL.TXNUM, TL.TXDESC ,(CASE WHEN DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN DORC='C' THEN GL.AMT ELSE 0 END) CRAMT,GL.DORC,GL.SUBTXNO,GL.ACCTNO,TL.BUSDATE
     FROM GLTRANA GL ,TLLOGALL TL
     WHERE  TL.TXNUM =GL.TXNUM AND TL.TXDATE =GL.TXDATE AND GL.DELTD <>'Y'
     AND TL.BUSDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')
      )GL

LEFT JOIN  (select * from  MITRAN where deltd <>'Y') MI
    ON MI.TXNUM =GL.TXNUM AND MI.TXDATE =GL.TXDATE AND
    GL.SUBTXNO =MI.SUBTXNO AND  GL.DORC =MI.DORC AND MI.ACCTNO =GL.ACCTNO
WHERE ((GL.ACCTNO = V_STRACCTNO)
      OR
      (SUBSTR(MI.ACCTNO,7,4) = '1141'
       AND MI.CUSTID = V_CUSTID  )
  )
  )*/

SELECT (SUM(CRAMT)-SUM (DRAMT))  BE_BALANCE
from
(SELECT (CASE WHEN GL.DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN GL.DORC='C' THEN GL.AMT ELSE 0 END) CRAMT, GL.ACCTNO,
          MI.CUSTID, MI.acctno MIACCTNO
     FROM GLTRAN GL , MITRAN MI
     WHERE  GL.DELTD <>'Y'
     AND GL.acctno = V_STRACCTNO
     AND GL.BKDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')
     AND MI.DELTD(+) <> 'Y'
     AND GL.txnum = MI.txnum(+)
     AND GL.txdate = MI.txdate(+)
     AND GL.subtxno = MI.subtxno(+)
     AND GL.DORC = MI.DORC(+)
     AND GL.AcctNo = MI.AcctNo(+)

 UNION ALL

SELECT (CASE WHEN GL.DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN GL.DORC='C' THEN GL.AMT ELSE 0 END) CRAMT, GL.ACCTNO,
          MI.CUSTID, MI.acctno MIACCTNO
     FROM GLTRAN GL , MITRAN MI
     WHERE  GL.DELTD <>'Y'
     AND MI.CUSTID = V_CUSTID
     AND GL.ACCTNO <> V_STRACCTNO
     AND SUBSTR(MI.ACCTNO,7,4) = '1141'
     AND GL.BKDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')
     AND MI.DELTD(+) <> 'Y'
     AND GL.txnum = MI.txnum(+)
     AND GL.txdate = MI.txdate(+)
     AND GL.subtxno = MI.subtxno(+)
     AND GL.DORC = MI.DORC(+)
     AND GL.AcctNo = MI.AcctNo(+)

UNION ALL

 SELECT (CASE WHEN GL.DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN GL.DORC='C' THEN GL.AMT ELSE 0 END) CRAMT, GL.ACCTNO,
          MI.CUSTID, MI.acctno MIACCTNO
     FROM GLTRANA GL , MITRAN MI
     WHERE  GL.DELTD <>'Y'
     AND GL.BKDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')
     AND GL.acctno = V_STRACCTNO
     AND MI.DELTD(+) <> 'Y'
     AND GL.txnum = MI.txnum(+)
     AND GL.txdate = MI.txdate(+)
     AND GL.subtxno = MI.subtxno(+)
     AND GL.DORC = MI.DORC(+)
     AND GL.AcctNo = MI.AcctNo(+)

 UNION ALL

 SELECT (CASE WHEN GL.DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN GL.DORC='C' THEN GL.AMT ELSE 0 END) CRAMT, GL.ACCTNO,
          MI.CUSTID, MI.acctno MIACCTNO
     FROM GLTRANA GL , MITRAN MI
     WHERE  GL.DELTD <>'Y'
     AND GL.BKDATE < TO_DATE (F_DATE, 'DD/MM/YYYY')
     AND MI.CUSTID = V_CUSTID
     AND GL.ACCTNO <> V_STRACCTNO
     AND SUBSTR(MI.ACCTNO,7,4) = '1141'
     AND MI.DELTD(+) <> 'Y'
     AND GL.txnum = MI.txnum(+)
     AND GL.txdate = MI.txdate(+)
     AND GL.subtxno = MI.subtxno(+)
     AND GL.DORC = MI.DORC(+)
     AND GL.AcctNo = MI.AcctNo(+)

      )GL
/*****************End of Modification****************************************/
;
   LOOP
   FETCH V_PCUR
   INTO BE_BALANCE;
   EXIT WHEN V_PCUR%NOTFOUND;
   END LOOP;
   CLOSE V_PCUR;
   END IF ;


 OPEN PV_REFCURSOR
             FOR

SELECT  ROUND(NVL(BE_BALANCE,0))  BE_BALANCE,GL.ACCTNO,GL.BUSDATE,GL.TXNUM,GL.TXDESC,
        GL.DRAMT  DRAMT,GL.CRAMT  CRAMT,MI.CUSTID
FROM
(
SELECT GL.TXDATE, GL.TXNUM, TL.TXDESC ,(CASE WHEN DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN DORC='C' THEN GL.AMT ELSE 0 END) CRAMT,GL.DORC,GL.SUBTXNO,GL.ACCTNO,TL.BUSDATE
     FROM GLTRAN GL ,TLLOG TL
     WHERE  TL.TXNUM =GL.TXNUM AND TL.TXDATE =GL.TXDATE AND GL.DELTD <>'Y'
      AND  TL.BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
      AND  TL.BUSDATE >= TO_DATE(F_DATE , 'DD/MM/YYYY')
)GL
LEFT JOIN
     (select * from  MITRAN where deltd <>'Y') MI ON MI.TXNUM =GL.TXNUM AND MI.TXDATE =GL.TXDATE AND
     GL.SUBTXNO =MI.SUBTXNO AND  GL.DORC =MI.DORC  AND MI.ACCTNO =GL.ACCTNO
WHERE  
     ((GL.ACCTNO = V_STRACCTNO )   OR
      (SUBSTR(MI.ACCTNO,7,4) = '1141'
       AND trim(MI.CUSTID) = trim(V_CUSTID)
      ))
 UNION ALL
SELECT  ROUND(NVL(BE_BALANCE,0))  BE_BALANCE,GL.ACCTNO,GL.BUSDATE,GL.TXNUM,GL.TXDESC,
        GL.DRAMT  DRAMT,GL.CRAMT  CRAMT,MI.CUSTID
FROM
(
SELECT GL.TXDATE, GL.TXNUM, TL.TXDESC ,(CASE WHEN DORC='D' THEN GL.AMT ELSE 0 END) DRAMT,
          (CASE WHEN DORC='C' THEN GL.AMT ELSE 0 END) CRAMT,GL.DORC,GL.SUBTXNO,GL.ACCTNO,TL.BUSDATE
     FROM GLTRANA GL ,TLLOGALL TL
     WHERE  TL.TXNUM =GL.TXNUM AND TL.TXDATE =GL.TXDATE AND GL.DELTD <>'Y'
      AND  TL.BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
      AND  TL.BUSDATE >= TO_DATE(F_DATE , 'DD/MM/YYYY')
      AND gl.bkdate  <= TO_DATE (T_DATE, 'DD/MM/YYYY')
      AND gl.bkdate  >= TO_DATE(F_DATE, 'DD/MM/YYYY')
)GL
LEFT JOIN
     (select * from  MITRAN where deltd <>'Y') MI ON MI.TXNUM =GL.TXNUM AND MI.TXDATE =GL.TXDATE AND
     GL.SUBTXNO =MI.SUBTXNO AND  GL.DORC =MI.DORC  AND MI.ACCTNO =GL.ACCTNO
WHERE   ((GL.ACCTNO = V_STRACCTNO )  OR
      (SUBSTR(MI.ACCTNO,7,4) = '1141'
       AND trim(MI.CUSTID) = trim(V_CUSTID)
      ) )
order by BUSDATE
      ;
            

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;

-- PROCEDURE
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
/
