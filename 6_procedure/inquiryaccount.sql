SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE inquiryaccount (
        PV_REFCURSOR IN OUT PKG_REPORT.REF_CURSOR,
        f_TABLENAME IN VARCHAR2,
        f_ACCTNO IN VARCHAR2,
        f_INDATE in varchar2,
        f_TYPE in varchar2)
  IS
  V_ACCTNO VARCHAR2(50);
  V_TABLENAME VARCHAR2(30);
  v_INDATE date;
  v_type char(1);
  v_margintype char(1);
  v_actype varchar2(4);
  v_groupleader varchar2(10);
  l_count number;
  l_isMarginAcc varchar2(1);
  l_cimastcheck_arrtype txpks_check.ddmastcheck_arrtype;
BEGIN

    V_ACCTNO:=F_ACCTNO;
    V_TABLENAME:=F_TABLENAME;
    v_type:=f_TYPE;
    IF LENGTH(v_INDATE) > 0 THEN
       v_INDATE:=to_date(f_INDATE,'DD/MM/YYYY');
    END IF;
if V_TABLENAME = 'SEMAST' then
    --Tai khoan binh thuong khong Margin
    -- DUcnv them SENDDEPOSIT : chung khoan gui luu ky
    OPEN PV_REFCURSOR FOR
      SELECT MST.ACTYPE, CF.CUSTODYCD, MST.ACCTNO, MST.AFACCTNO, MST.LASTDATE, MST.CODEID, MST.IRCD, MST.STATUS, MST.COSTPRICE, MST.TRADE-NVL(B.SECUREAMT,0) TRADE,
             MST.WTRADE, MST.MORTAGE-NVL(B.SECUREMTG,0) MORTAGE , MST.MARGIN, MST.NETTING, MST.STANDING,NVL(B.SECUREAMT,0)+NVL(B.SECUREMTG,0) SECURED,
             MST.WITHDRAW, MST.BLOCKED, MST.DEPOSIT, MST.LOAN,MST.PREVQTTY,MST.DTOCLOSE,MST.SDTOCLOSE,MST.DCRQTTY,MST.DCRAMT,MST.DEPOFEEACR,
             MST.RECEIVING, CCY.SYMBOL, CCY.PARVALUE,SE_INF.PREVCLOSEPRICE PRICE, CD1.CDCONTENT DESC_STATUS, B.sereceiving AVLRECEIVING,
             GREATEST(MST.TRADE-NVL(B.SECUREAMT,0)+NVL(B.sereceiving,0),0) AVLTRADING,
             (MST.MORTAGE - NVL(B.SECUREMTG,0) + MST.STANDING) MORADDSTAND, ABS(STANDING) ABSTANDING,
             MST.SENDDEPOSIT
          FROM AFMAST AF, SEMAST MST, CFMAST CF, SBSECURITIES CCY, SECURITIES_INFO SE_INF, ALLCODE CD1, v_getsellorderinfo B
          WHERE AF.ACCTNO = MST.AFACCTNO AND AF.CUSTID= CF.CUSTID AND MST.ACCTNO=B.SEACCTNO(+)
           AND CCY.CODEID=MST.CODEID AND MST.ACCTNO = V_ACCTNO
               AND TRIM(CD1.CDTYPE) = 'SE' AND SE_INF.CODEID=CCY.CODEID
           AND TRIM(CD1.CDNAME)='STATUS' AND TRIM(MST.STATUS) = TRIM(CD1.CDVAL);
ELSIF V_TABLENAME = 'CFMAST' THEN
  OPEN PV_REFCURSOR FOR
      SELECT MST.ACTYPE, MST.ACCTNO, MST.AFTYPE, CF.PIN, CF.MOBILESMS TRADEPHONE, MST.ADVANCELINE,
             MST.DEPOSITLINE, MST.BRATIO, MST.TERMOFUSE,CF.CONSULTANT,CF.MOBILESMS PHONE1,
             CF.TRADEFLOOR,CF.TRADEONLINE,CF.IDCODE, MST.STATUS, MST.LASTDATE,
             MST.DESCRIPTION,
             CF.FULLNAME, CF.ADDRESS,CF.EMAIL, CF.IDCODE LICENSE, CD1.CDCONTENT DESC_TERMOFUSE, CD3.CDCONTENT DESC_STATUS,
             CD4.CDCONTENT DESC_AFTYPE
      FROM CFMAST CF, AFMAST MST,ALLCODE CD1,  ALLCODE CD3, ALLCODE CD4
      WHERE CF.CUSTID = MST.CUSTID AND MST.ACCTNO = V_ACCTNO
      AND CD1.CDTYPE = 'CF' AND CD1.CDNAME='TERMOFUSE' AND MST.TERMOFUSE = CD1.CDVAL
      AND CD3.CDTYPE = 'CF' AND CD3.CDNAME='STATUS' AND MST.STATUS = CD3.CDVAL
      AND CD4.CDTYPE = 'CF' AND CD4.CDNAME='AFTYPE' AND MST.AFTYPE = CD4.CDVAL ;
ELSIF V_TABLENAME = 'GLMAST' THEN
  OPEN PV_REFCURSOR FOR
      SELECT MST.GLBANK, MST.ACCTNO, MST.CCYCD, MST.SUBCD, MST.ACNAME, MST.BALANCE, MST.AVGBAL, MST.YEARBAL, MST.INTRATE,
             MST.DDR, MST.DCR,  MST.MDR, MST.MCR, MST.YDR, MST.YCR, MST.DTXCOUNT, MST.YTXCOUNT, CCY.SHORTCD, MST.LSTDATE,
             case when MST.BALANCE >=0 then MST.BALANCE else 0 end CREDIT_BAL,
             case when MST.BALANCE < 0 then abs(MST.BALANCE) else 0 end DEBIT_BAL
      FROM GLMAST MST, SBCURRENCY CCY
      WHERE CCY.CCYCD=MST.CCYCD AND MST.ACCTNO = V_ACCTNO;
end if;
   EXCEPTION
    WHEN others THEN
    pr_error('InquiryAccount','Error:' || SQLERRM || dbms_utility.format_error_backtrace);
        return;
END;
/
