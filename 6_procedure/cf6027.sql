SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE cf6027(
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   P_CUSTODYCD            IN       VARCHAR2, /*SO TK LUU KY */
   P_CONTRACT             IN       VARCHAR2, /*SO HOP DONG*/
   P_CFAUTH               IN       VARCHAR2, /*NGUOI NHAN */
   P_SIGNTYPE             IN       VARCHAR2 /*NGUOI KY */
   )
IS
    -- REPORT ON THE DAY BECOME/IS NO LONGER MAJOR SHAREHOLDER, INVESTORS HOLDING 5% OR MORE OF SHARES
    -- PERSON      DATE                 COMMENTS
    -- ---------   ------               -------------------------------------------
    -- THOAI.TRAN    06-11-2019           CREATED
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

    V_CUSTODYCD         VARCHAR2(20);
    V_IDCODE           VARCHAR2(200);
    V_OFFICE           VARCHAR2(200);
    V_REFNAME          VARCHAR2(200);
    V_TLLICENSENO      VARCHAR2(200);
    V_TLFULLNAME       VARCHAR2(200);
    V_TLCMP            VARCHAR2(200);

BEGIN
     V_STROPTION := OPT;
     IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
     ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
     ELSE
        V_STRBRID:=BRID;
     END IF;

    V_CUSTODYCD := REPLACE(P_CUSTODYCD,'.','');

    IF P_SIGNTYPE = '002' THEN
        SELECT MAX(CASE WHEN  VARNAME='1IDCODE' THEN EN_VARDESC ELSE '' END),
           MAX(CASE WHEN  VARNAME='1OFFICE' THEN EN_VARDESC ELSE '' END),
           MAX(CASE WHEN  VARNAME='1REFNAME' THEN EN_VARDESC ELSE '' END)
            INTO V_IDCODE, V_OFFICE, V_REFNAME
        FROM SYSVAR WHERE VARNAME IN ('1IDCODE','1OFFICE','1REFNAME');
    ELSE
        SELECT
           MAX(CASE WHEN  VARNAME='2IDCODE' THEN EN_VARDESC ELSE '' END),
           MAX(CASE WHEN  VARNAME='2OFFICE' THEN EN_VARDESC ELSE '' END),
           MAX(CASE WHEN  VARNAME='2REFNAME' THEN EN_VARDESC ELSE '' END)
            INTO V_IDCODE, V_OFFICE, V_REFNAME
        FROM SYSVAR WHERE VARNAME IN ('2IDCODE','2OFFICE','2REFNAME');
    END IF;
-- LAY THONG TIN NGUOI UY QUYEN
    BEGIN
        SELECT  MAX(NVL(FULLNAME,'')) ,-- TEN NGUOI NHAN DC UY QUYEN
        MAX(NVL(LICENSENO,''))         --COMANY CUA NGUOI DUOC UY QUYEN -- CHECK LAI VOI CHI DIEM
        INTO  V_TLFULLNAME,V_TLLICENSENO
        FROM CFAUTH
        WHERE CUSTID= P_CFAUTH;
    EXCEPTION
        WHEN OTHERS  THEN
            V_TLFULLNAME := 'A';
            V_TLLICENSENO:= 'A';
            V_TLCMP :='A';
    END;

OPEN PV_REFCURSOR FOR

    SELECT V_IDCODE SIGN_IDCODE, V_OFFICE SIGN_OFFICE, V_REFNAME SIGN_REFNAME,V_TLFULLNAME TLFULLNAME,V_TLLICENSENO TLLICENSENO,V_TLCMP TLCMP,
    MST.*, UTILS.FNC_NUMBER2WORK(MST.TOTALVALUE,'Vietnam Dong') STRQTTYVALUE
    FROM
    (
         SELECT CF.FULLNAME FUNDNAME,
        ISS.FULLNAME BONDSISSUERS,
        (CASE WHEN CF.COUNTRY ='234' THEN SUBSTR(CF.CUSTODYCD,5,6) ELSE CF.TRADINGCODE END) TRANDINGCODE,
        CF.CUSTODYCD CUSTODYCD,
        CF.CIFID CIFID,
        DD.REFCASAACCT IICANUMBER,
        CP.CODEID BONDCODE,
        SB.ISSUEDATE ISSUEDATE,
        SB.EXPDATE MATURITYDATE,
       -- SUM( CP.QTTY) ,               LAY TRONG BANG CRPHY
       -- SUM(CP.QTTY*CP.CLVALUE) TOTALVALUE
        SUM(DOC.QTTY) TOTALQTTY,
        SUM(DOC.QTTY* SB.PARVALUE)TOTALVALUE
        FROM  CRPHYSAGREE CP, ISSUERS ISS, CFMAST CF,DDMAST DD,(SELECT A.* FROM DOCSTRANSFER A,(SELECT DISTINCT A.CRPHYSAGREEID
        FROM CRPHYSAGREE_LOG_ALL A, CRPHYSAGREE B
        WHERE A.TLTXCD='1405') MST
        WHERE A.CRPHYSAGREEID =MST.CRPHYSAGREEID )DOC,SBSECURITIES SB
        WHERE CP.ISSUERID=ISS.ISSUERID
        AND DOC.CRPHYSAGREEID = CP.CRPHYSAGREEID
        AND CP.CODEID = SB.CODEID
        AND CF.CUSTODYCD=DD.CUSTODYCD
        AND CF.CUSTODYCD=CP.CUSTODYCD
        AND DD.ACCOUNTTYPE='IICA'
        AND DD.ISDEFAULT ='Y'
        AND DD.STATUS <> 'C'
        AND CF.CUSTODYCD LIKE V_CUSTODYCD
        AND CP.CRPHYSAGREEID = P_CONTRACT
        GROUP BY CF.FULLNAME,ISS.FULLNAME,CF.CUSTODYCD, CF.CIFID,DD.REFCASAACCT,CP.CODEID,SB.ISSUEDATE,
        SB.EXPDATE,CF.COUNTRY,CF.TRADINGCODE,CP.QTTY
    )MST;

EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('CF6027: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;
/
