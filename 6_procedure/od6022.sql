SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE od6022 (
    PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
    OPT            IN       VARCHAR2,
    BRID           IN       VARCHAR2,
    F_DATE         IN       VARCHAR2,
    T_DATE   IN       VARCHAR2,
    P_BRK      IN       VARCHAR2
)
IS

    V_F_DATE   DATE;
    V_T_DATE   DATE;
    V_BRK       VARCHAR2(20);
BEGIN

    IF  (P_BRK <> 'ALL') THEN
         V_BRK := P_BRK;
    ELSE
         V_BRK := '%';
    END IF;

    V_F_DATE := TO_DATE(F_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    V_T_DATE := TO_DATE(T_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    ----------------------------------------------------------
    OPEN PV_REFCURSOR FOR
        SELECT TO_CHAR(CLEARDATE,'DD/MM/YYYY') CLEARDATE, TXDATE, BROKER,
               MAX(BROKERNAME) BROKERNAME,
               MAX(BANKACCBROKER) BANKACCBROKER,
               MAX(BANKNAMEBROKER) BANKNAMEBROKER,
               MAX(BRANKBANK) BRANKBANK,
               MAX(BENEFICIARY) BENEFICIARY,
               MAX(BANKCITADCODE) CITAD,
               UTILS.SO_THANH_CHU2(SUM(FEE)) FEE,
               UTILS.SO_THANH_CHU2(SUM(TAX)) TAX,
               UTILS.SO_THANH_CHU2((SUM(FEE) + SUM(TAX))) TOTAL,
               ' ' TOTAL_CHAR,
               'VALUE DATE: ' || TO_CHAR(CLEARDATE,'DD/MM/YYYY') || ' Broker fee ' || (CASE WHEN SUM(TAX) > 0 THEN 'tax' ELSE '' END) DESCRIPTION
        FROM (
            SELECT FA.SHORTNAME BROKER, FA.FULLNAME BROKERNAME, FA.BANKACCTNO BANKACCBROKER, FA.BANKNAME BANKNAMEBROKER, FA.BRANCHNAME BRANKBANK, FA.BENEFICIARY, FA.BANKCITADCODE, FE.CLEARDATE, FE.TXDATE,
                  (FE.FEEAMT -NVL(FE.PAIDFEEAMT,0))FEE,
                  (FE.VAT -NVL(FE.PAIDVAT,0))TAX
            FROM VW_STSCHD_ALL FE, FAMEMBERS FA, CFMAST CF,
            (
                SELECT * FROM ODMAST
                UNION ALL
                SELECT * FROM ODMASTHIST
            ) OD,
            (
                SELECT VARVALUE  FROM SYSVAR WHERE VARNAME = 'DEALINGCUSTODYCD'
            ) SYS
            WHERE FA.AUTOID = OD.MEMBER
            AND OD.ORDERID = FE.ORDERID
            AND OD.ODTYPE IN('ODT','ODG')
            AND FE.CUSTODYCD = CF.CUSTODYCD
            AND FE.DUETYPE IN ('SM','RM')
            AND FE.DELTD = 'N'
            AND FE.FVSTATUS = 'A'
            AND CF.FEEDAILY <> 'N'
            AND SUBSTR(CF.CUSTODYCD,0,4) NOT LIKE SYS.VARVALUE
            AND GREATEST(FE.FEEAMT-NVL(FE.PAIDFEEAMT,0),0) + GREATEST(FE.VAT-NVL(FE.PAIDVAT,0),0) <> 0
            AND FE.CLEARDATE BETWEEN V_F_DATE AND V_T_DATE
            AND FA.SHORTNAME LIKE V_BRK
        )
        GROUP BY BROKER, CLEARDATE, TXDATE
        ORDER BY BROKER, CLEARDATE;

EXCEPTION WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('OD6022 ERROR');
    
    RETURN;
END;
/
