SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE BA0018(
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   PV_ISSUERS             IN       VARCHAR2,
   P_CONTRACT             IN       VARCHAR2,
   PV_SYMBOL              IN       VARCHAR2,
   I_DATE                 IN       VARCHAR2,
   PV_CUSTODYCD           IN       VARCHAR2
   )
IS
    -- BA0018: CONG VAN YEU CAU THONG TIN TAI KHOAN
    -- PERSON      DATE                 COMMENTS
    -- ---------   ------               -------------------------------------------
    -- THOAI.TRAN    20-11-2019           CREATED
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

    V_PAYMENTDATE  DATE;
    V_CUSTODYCD    VARCHAR(20);
    V_TICKER       VARCHAR(20);
    V_CURRDATE     DATE;
    V_ISSNAME      VARCHAR(20);
    v_PREDATE      DATE;
    V_CONTRACTNO    VARCHAR(20);

BEGIN
     V_STROPTION := OPT;
     IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
     ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
     ELSE
        V_STRBRID:=BRID;
     END IF;
    V_CUSTODYCD := REPLACE(PV_CUSTODYCD,'.','');
    IF(V_CUSTODYCD='ALL') THEN
        V_CUSTODYCD:='%';
    ELSE
        V_CUSTODYCD:=V_CUSTODYCD;
    END IF;
    V_TICKER:=PV_SYMBOL;
    V_PAYMENTDATE  := TO_DATE(I_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    V_ISSNAME:=PV_ISSUERS;
    V_CURRDATE:=GETCURRDATE();
    V_CONTRACTNO:=P_CONTRACT;
    --Lay predate 15 (Lay luon ngay nghi le)
     /*SELECT MIN(SBDATE) INTO V_PREDATE FROM (
    SELECT AUTOID,SBDATE FROM SBCLDR WHERE CLDRTYPE ='000' AND HOLIDAY='N' AND ROWNUM <=15
              AND SBDATE <=(
                    SELECT MAX(SBDATE)
                            FROM SBCLDR
                            WHERE CLDRTYPE ='000' AND HOLIDAY='N'
                                  AND SBDATE < '04-nov-2019')
            ORDER BY SBDATE DESC);*/

OPEN PV_REFCURSOR FOR
SELECT
        TO_CHAR(V_CURRDATE,'DD/MM/YYYY') REPORTDATE
       ,CF.FULLNAME FUNDNAME
       ,SB.SYMBOL
       ,SB.CONTRACTNO
       ,TO_CHAR(SB.CONTRACTDATE,'DD/MM/YYYY') CONTRACTDATE
       ,ISS.FULLNAME
       ,NVL(SB.THIRDPARTNER,'THIRDPARTNER')  THIRDPARTNER
       ,TO_CHAR(SB.ISSUEDATE,'DD/MM/YYYY')  ISSUEDATE
       ,TO_CHAR(UTILS.SO_THANH_CHU(NVL(SB.PARVALUE,0)))              PARVALUE   --MENH GIA
       ,TO_CHAR(SB.EXPDATE,'DD/MM/YYYY') EXPDATE
       ,TO_CHAR(UTILS.SO_THANH_CHU(NVL(SB.VALUEOFISSUE,0))) VALUEOFISSUE --GIA TRI PHAT HANGH 'VND 54,545,324'
       ,'STRVALUE' STRVALUE --CHUYEN VALUE THANH CHU
       ,TO_CHAR(SB.INTCOUPON)   INTCOUPON--LAI SUAT
       --,TO_CHAR(V_PREDATE,'DD/MM/YYYY') PREVDATE15-- LAY 15 NGAY TRC --V_PAYMENTDATE
       ,TO_CHAR(GETPREVDATE(V_PAYMENTDATE,15),'DD/MM/YYYY') PREVDATE15 --Fix getpredate lai nhu ham tren
        FROM CFMAST CF, BONDSEMAST BSE, SBSECURITIES SB,ISSUERS ISS,BONDTYPEPAY BT
        WHERE CF.CUSTODYCD=BSE.CUSTODYCD
            AND ISS.ISSUERID=SB.ISSUERID
            AND BSE.BONDCODE=SB.CODEID
            AND BSE.BONDCODE=BT.BONDCODE
            AND SB.SYMBOL LIKE  V_TICKER
            AND CF.CUSTODYCD LIKE V_CUSTODYCD
            AND BT.PAYMENTDATE = V_PAYMENTDATE  -- LAY DU LIEU THEO PAYMENTDATE (KHI CUNG SYMBOL/CODEID KHAC DATE)
            AND ISS.SHORTNAME LIKE  V_ISSNAME
            AND SB.CONTRACTNO = V_CONTRACTNO;
EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('BA0018: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;
/
