SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE ca0022 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   PV_CAMASTID    IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2
)
IS
    L_CAMASTID VARCHAR2(100);
    L_CUSTODYCD VARCHAR2(100);
BEGIN
    L_CAMASTID := REPLACE(PV_CAMASTID, '.', '');
    L_CUSTODYCD := REPLACE(PV_CUSTODYCD, '.', '');

    OPEN PV_REFCURSOR FOR
    SELECT DEM.FULLNAME DEPOSITNAME, DEM.DEPOSITID, SB.SYMBOL, SB.BONDNAME, CAS.*
    FROM CAMAST CA, DEPOSIT_MEMBER DEM,
    (SELECT * FROM SYSVAR WHERE VARNAME = 'DEPOSITID') DEP,
    (SELECT * FROM SBSECURITIES WHERE TRADEPLACE = '099') SB,
    (
        SELECT CAS.CAMASTID, CAS.TRADE, CAS.AQTTY, CAS.QTTY, (CAS.TRADE - CAS.QTTY) REMAIN_QTTY, CF.*
        FROM CASCHD CAS, AFMAST AF,
        (
            SELECT CF.CUSTID, CF.CUSTODYCD, CF.FULLNAME, A1.CDCONTENT COUNTRY,
                (CASE WHEN CF.COUNTRY <> '234' THEN CF.TRADINGCODE
                      ELSE CF.IDCODE
                 END) IDCODE
            FROM CFMAST CF,
            (SELECT * FROM ALLCODE WHERE CDNAME = 'COUNTRY' AND CDTYPE = 'CF') A1
            WHERE CF.STATUS NOT IN ('C')
            AND CF.COUNTRY = A1.CDVAL
            AND CF.CUSTODYCD = L_CUSTODYCD
        ) CF
        WHERE CF.CUSTID = AF.CUSTID
        AND AF.ACCTNO = CAS.AFACCTNO
        AND CAS.STATUS NOT IN ('C')
        AND CAS.DELTD = 'N'
    ) CAS
    WHERE DEM.DEPOSITID = DEP.VARVALUE
    AND CA.CODEID = SB.CODEID
    AND CA.CATYPE = '040'
    AND CA.CAMASTID = CAS.CAMASTID
    AND CA.CAMASTID = L_CAMASTID;


EXCEPTION WHEN OTHERS THEN
    PLOG.ERROR ('CA0022: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
    RETURN;
END;
/
