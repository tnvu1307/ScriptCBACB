SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE ca0016 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   pv_CUSTODYCD   IN       VARCHAR2,
   PLSENT         in       varchar2
 )
IS
--
-- PURPOSE: GIAY DE NGHI CHUYEN QUYEN DO TAT TOAN TAI KHOAN
-- MODIFICATION HISTORY
-- PERSON      DATE      COMMENTS
-- QUOCTA   16-12-2011   CREATED
-- ---------   ------  -------------------------------------------

   V_STROPTION         VARCHAR2  (5);
   V_STRBRID           VARCHAR2  (4);
   v_FromDate          DATE;
   v_ToDate            DATE;
   V_pv_CUSTODYCD      VARCHAR2(20);


BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS
   v_FromDate         := TO_DATE(F_DATE, 'DD/MM/YYYY');
   v_ToDate           := TO_DATE(T_DATE, 'DD/MM/YYYY');

   V_pv_CUSTODYCD     := UPPER(REPLACE(pv_CUSTODYCD, '.', ''));

   -- GET REPORT'S DATA

OPEN PV_REFCURSOR
FOR

SELECT MST.*,PLSENT sendto, CF.FULLNAME FULLNAME_FR,
       --cf.IDCODE,
       (case when cf.country = '234' then cf.idcode else cf.tradingcode end) IDCODE_FR,
       (case when cf.country = '234' then cf.IDDATE else cf.tradingcodedt end) IDDATE_FR,
       CF.IDPLACE IDPLACE_FR,
       AL.CDCONTENT COUNTTRY_FR, SB.SYMBOL, ISS.FULLNAME ISS_NAME,
       DECODE(SUBSTR(CF.CUSTODYCD, 4, 1), 'C', MST.AMT, 0) AMT_TN,
       DECODE(SUBSTR(CF.CUSTODYCD, 4, 1), 'F', MST.AMT, 0) AMT_NN,
       DECODE(SUBSTR(CF.CUSTODYCD, 4, 1), 'P', MST.AMT, 0) AMT_TD
FROM   CFMAST CF, ALLCODE AL, SBSECURITIES SB, ISSUERS ISS,
        (SELECT MST.CUSTODYCD, MST.CODEID, SUM(NVL(MST.AMT, 0)) AMT, MAX(NVL(MST.TOMEMCUS, NULL)) TOMEMCUS,
                MAX(NVL(MST.FULLNAME, NULL)) FULLNAME, MAX(NVL(MST.IDCODE, NULL)) IDCODE,
                MAX(NVL(MST.IDDATE, NULL)) IDDATE, MAX(NVL(MST.IDPLACE, NULL)) IDPLACE,
                MAX(NVL(MST.COUNTRY, NULL)) COUNTRY, MAX(NVL(MST.TO_CUSTODYCD, NULL)) TO_CUSTODYCD,
                MAX(NVL(MST.TOSYMBOL, NULL)) TOSYMBOL, MAX(NVL(MST.TOISSNAME, NULL)) TOISSNAME
        FROM
              (SELECT TLF.TXNUM, TLF.TXDATE,
              MAX(DECODE(TLF.FLDCD, '36', TLF.CVALUE, NULL)) CUSTODYCD,
              MAX(DECODE(TLF.FLDCD, '01', TLF.CVALUE, NULL)) CODEID,
              MAX(DECODE(TLF.FLDCD, '21', TLF.NVALUE, NULL)) AMT,
              MAX(DECODE(TLF.FLDCD, '08', TLF.CVALUE, NULL)) TOMEMCUS,
              MAX(DECODE(TLF.FLDCD, '95', TLF.CVALUE, NULL)) FULLNAME,
              MAX(DECODE(TLF.FLDCD, '97', TLF.CVALUE, NULL)) IDCODE,
              MAX(DECODE(TLF.FLDCD, '98', TLF.CVALUE, NULL)) IDDATE,
              MAX(DECODE(TLF.FLDCD, '99', TLF.CVALUE, NULL)) IDPLACE,
              MAX(DECODE(TLF.FLDCD, '81', TLF.CVALUE, NULL)) COUNTRY,
              MAX(DECODE(TLF.FLDCD, '07', TLF.CVALUE, NULL)) TO_CUSTODYCD,
              MAX(DECODE(TLF.FLDCD, '60', TLF.CVALUE, NULL)) TOSYMBOL,
              MAX(DECODE(TLF.FLDCD, '61', TLF.CVALUE, NULL)) TOISSNAME
                FROM VW_TLLOG_ALL TL, VW_TLLOGFLD_ALL TLF
                WHERE TL.DELTD <> 'Y'
                AND   TL.TLTXCD       = '3383'
                AND   TL.TXDATE       = TLF.TXDATE
                AND   TL.TXNUM        = TLF.TXNUM
                AND   TL.BUSDATE BETWEEN v_FromDate AND v_ToDate
              GROUP BY TLF.TXNUM, TLF.TXDATE
              HAVING MAX(DECODE(TLF.FLDCD, '36', TLF.CVALUE, NULL)) = V_pv_CUSTODYCD) MST
        WHERE MST.AMT > 0
        GROUP BY MST.CUSTODYCD, MST.CODEID) MST
WHERE   CF.CUSTODYCD = MST.CUSTODYCD
AND     AL.CDVAL     = CF.COUNTRY
AND     AL.CDNAME    = 'COUNTRY'
AND     AL.CDTYPE    = 'CF'
AND     MST.CODEID   = SB.CODEID
AND     SB.ISSUERID  = ISS.ISSUERID
;

EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;
/
