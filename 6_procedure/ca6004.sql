SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE CA6004(
   PV_REFCURSOR           IN OUT   PKG_REPORT.REF_CURSOR,
   OPT                    IN       VARCHAR2,
   BRID                   IN       VARCHAR2,
   I_DATE                 IN       VARCHAR2, /*REPORT DATE */
   PV_SYMBOL               IN       VARCHAR2     /*SYMBOL*/
   )
IS
    -- FUNDING NOTICE
    -- PERSON      DATE                 COMMENTS
    -- ---------   ------               -------------------------------------------
    -- THOAI.TRAN    14-11-2019           CREATED
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0

    V_REPORTDATE          DATE;
    V_SYMBOL         VARCHAR2(20);
    V_SHVAMT        NUMBER;
    V_BANKACCTNO    VARCHAR2(100);
    V_FULLNAME      VARCHAR2(100);
    V_BANKAFFILIATE VARCHAR2(100);
    V_OWNERNAME     VARCHAR2(100);
BEGIN
     V_STROPTION := OPT;
     IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
     ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
     ELSE
        V_STRBRID:=BRID;
     END IF;
    V_REPORTDATE  := TO_DATE(I_DATE, SYSTEMNUMS.C_DATE_FORMAT);
    IF PV_SYMBOL <> 'ALL' THEN
        V_SYMBOL := PV_SYMBOL;
    ELSE
        V_SYMBOL :='%';
    END IF;

    -- TIEN TRA CHO  TAI KHOAN TU DOANH
    SELECT
    NVL(SUM(CAS.AMT),0)
    INTO V_SHVAMT
    FROM CAMAST CA, CASCHD CAS,SBSECURITIES SB,CFMAST CF, AFMAST AF --, DDMAST DD
        WHERE CA.CAMASTID =CAS.CAMASTID
            AND CA.CODEID=SB.CODEID
            AND CF.CUSTID=AF.CUSTID
            --AND AF.ACCTNO=DD.AFACCTNO
            AND AF.ACCTNO=CAS.AFACCTNO
            --AND CA.CATYPE ='010'        -- SEARCH IN ALLCODE 'CHIA CO TUC BANG TIEN'
            AND CF.CIFID ='1400411151' -- SO TK TU DOANH CUA SHB
            AND CA.ACTIONDATE = V_REPORTDATE
            AND SB.SYMBOL LIKE V_SYMBOL;

    -- THONG TIN BANKNOSTRO
    SELECT BANKACCTNO,FULLNAME,BANKAFFILIATE,OWNERNAME
    INTO V_BANKACCTNO,
    V_FULLNAME,
    V_BANKAFFILIATE,
    V_OWNERNAME
    FROM BANKNOSTRO WHERE BANKTRANS ='INTRFCAREG';

OPEN PV_REFCURSOR FOR
       SELECT V_SHVAMT SHVAMT,
       V_BANKACCTNO BANKACCTNO,
       V_FULLNAME FULLNAME,
       V_BANKAFFILIATE BANKAFFILIATE,
       V_OWNERNAME OWNERNAME,
       NVL(SUM(CAS.AMT),0) - V_SHVAMT SSDAMT,
       NVL(SUM(CAS.AMT),0) TOTAL,
       TO_CHAR(V_REPORTDATE,'DD MON YYYY') VALUEDATE
       FROM CAMAST CA, CASCHD CAS,SBSECURITIES SB,CFMAST CF, AFMAST AF --, DDMAST DD
       WHERE CA.CAMASTID =CAS.CAMASTID
       AND CA.CODEID=SB.CODEID
       AND CF.CUSTID=AF.CUSTID --AND AF.ACCTNO=DD.AFACCTNO
       AND AF.ACCTNO=CAS.AFACCTNO
       --AND CA.CATYPE IN ('010','023','011','','')        -- SEARCH IN ALLCODE 'CHIA CO TUC BANG TIEN'
       AND CA.ACTIONDATE = V_REPORTDATE
       AND SB.SYMBOL LIKE V_SYMBOL;
EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('CA6004: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;
/
