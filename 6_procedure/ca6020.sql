SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE CA6020 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,

   P_CACODE       IN       VARCHAR2
)
IS
    -- person      date                 comments
    -- ---------   ------               -------------------------------------------
    -- TRI.BUI     08/07/2020           CREATED
    RE_DATE       VARCHAR2 (20);
    CRE_DATE       VARCHAR2 (50);
    V_CACODE       VARCHAR2 (20);
    V_STROPTION    VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
    V_STRBRID      VARCHAR2 (4);       -- USED WHEN V_NUMOPTION > 0
    V_COUNT      NUMBER;
    V_AMC      VARCHAR2 (20);
BEGIN
    V_STROPTION := OPT;
    IF V_STROPTION = 'A' THEN
        V_STRBRID := '%';
    ELSIF V_STROPTION = 'B' THEN
        V_STRBRID := SUBSTR(BRID,1,2) || '__' ;
    ELSE
        V_STRBRID:= BRID;
    END IF;
    V_CACODE := P_CACODE;
    -----
    SELECT TO_CHAR(GETCURRDATE,'DD Mon RRRR') INTO RE_DATE FROM DUAL;
    SELECT TO_CHAR(SYSDATE,'DD/MM/YYYY HH:MI:SS AM') INTO CRE_DATE  FROM DUAL;
    -----
    SELECT COUNT(*) INTO V_COUNT --LAY SO LUONG AMC
    FROM
    (
    SELECT FA.SHORTNAME
    FROM CASCHDTEMP_LIST CAT, CAMAST CA ,AFMAST AF, CFMAST CF, SBSECURITIES SB, (SELECT * FROM FAMEMBERS WHERE ROLES ='AMC')FA
    WHERE CAT.CAMASTID = CA.CAMASTID
          AND CAT.AFACCTNO = AF.ACCTNO
          AND AF.CUSTID = CF.CUSTID
          AND CF.AMCID = FA.AUTOID(+)
          AND CAT.CODEID = SB.CODEID
          AND CA.CATYPE IN ('010','015','016','033')
          AND FA.SHORTNAME IS NOT NULL
          AND CAT.CAMASTID LIKE V_CACODE
    GROUP BY FA.SHORTNAME
     );
--==============MAIN QUERY================
IF V_COUNT = 1 THEN -- 1 AMC
  OPEN PV_REFCURSOR
  FOR
        SELECT
                 CA.CATYPE
                ,SB.SYMBOL AS TICKER
                ,TO_CHAR(CA.ACTIONDATE,'DD FMMONTH RRRR') AS PAYMENT_DATE
                ,CASE WHEN (MAX(FA.SHORTNAME) OVER(PARTITION BY CA.CATYPE)) IS NULL THEN NULL
                    ELSE '_'||(MAX(FA.SHORTNAME) OVER(PARTITION BY CA.CATYPE))
                 END AS AMC
                ,TO_CHAR(SB.ISSUEDATE,'DD FMMONTH RRRR') AS ISSUEDATE
                ,CF.FULLNAME AS CLIENT_FULLNAME
                ,CF.TRADINGCODE AS STC
                ,CF.CIFID AS PORTFOLIO_NUMBER
        FROM CASCHDTEMP_LIST CAT, CAMAST CA ,AFMAST AF, CFMAST CF, SBSECURITIES SB, (SELECT * FROM FAMEMBERS WHERE ROLES ='AMC')FA
        WHERE CAT.CAMASTID = CA.CAMASTID
              AND CAT.AFACCTNO = AF.ACCTNO
              AND AF.CUSTID = CF.CUSTID
              AND CF.AMCID = FA.AUTOID(+)
              AND CAT.CODEID = SB.CODEID
              AND CA.CATYPE IN ('010','015','016','033')
              AND CAT.CAMASTID LIKE V_CACODE;
ELSE -- NHIEU AMC
   OPEN PV_REFCURSOR
   FOR
        SELECT
                 CA.CATYPE
                ,SB.SYMBOL AS TICKER
                ,TO_CHAR(CA.ACTIONDATE,'DD FMMONTH RRRR') AS PAYMENT_DATE
                ,NULL AS AMC
                ,TO_CHAR(SB.ISSUEDATE,'DD FMMONTH RRRR') AS ISSUEDATE
                ,CF.FULLNAME AS CLIENT_FULLNAME
                ,CF.TRADINGCODE AS STC
                ,CF.CIFID AS PORTFOLIO_NUMBER
        FROM CASCHDTEMP_LIST CAT, CAMAST CA ,AFMAST AF, CFMAST CF, SBSECURITIES SB, (SELECT * FROM FAMEMBERS WHERE ROLES ='AMC')FA
        WHERE CAT.CAMASTID = CA.CAMASTID
              AND CAT.AFACCTNO = AF.ACCTNO
              AND AF.CUSTID = CF.CUSTID
              AND CF.AMCID = FA.AUTOID(+)
              AND CAT.CODEID = SB.CODEID
              AND CA.CATYPE IN ('010','015','016','033')
              AND CAT.CAMASTID LIKE V_CACODE;
END IF;
EXCEPTION
  WHEN OTHERS
   THEN
      PLOG.ERROR ('CA6020: ' || SQLERRM || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE);
      RETURN;
END;                           -- PROCEDURE
/
