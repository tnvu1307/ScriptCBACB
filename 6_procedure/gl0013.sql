SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE GL0013 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2
     )
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
--
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   21-NOV-06  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION        VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID          VARCHAR2 (4);              -- USED WHEN V_NUMOPTION > 0


-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE
BEGIN
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS

   -- END OF GETTING REPORT'S PARAMETERS

   -- GET REPORT'S DATA

      OPEN PV_REFCURSOR
       FOR

SELECT MI.ACCTNO ,GL.DORC ,TL.TXDESC,(CASE  WHEN GL.DORC ='C' THEN  GL.AMT ELSE 0 END) CAMT,
(CASE WHEN GL.DORC ='D' THEN GL.AMT ELSE 0 END ) DAMT
 ,TL.BUSDATE ,MI.TXDATE ,MI.TXNUM,TL.TLTXCD ,TLFLD.CVALUE AFACCTNO,MI.CUSTID
FROM MITRAN MI,
(
SELECT * FROM  TLLOG
        WHERE TLTXCD  IN ('1140','1141','1100','1101')
       AND BUSDATE =TO_DATE( I_DATE  ,'DD/MM/YYYY')
)TL
,TLLOGFLD TLFLD,GLTRAN GL
WHERE TL.TXNUM =TLFLD.TXNUM
AND  TL.TXDATE =TLFLD.TXDATE
AND TL.TXNUM =GL.TXNUM
AND TL.TXDATE =GL.TXDATE
AND TLFLD.FLDCD  = '03'
AND GL.TXNUM =MI.TXNUM
AND GL.TXDATE =MI.TXDATE
AND GL.DORC =MI.DORC
AND GL.SUBTXNO =MI.SUBTXNO
AND GL.ACCTNO =MI.ACCTNO

AND  ((SUBSTR(GL.ACCTNO,7,4) LIKE '1121'
      AND SUBSTR(GL.ACCTNO,8,3) IN ( '010','020','040','050','080','090')  )
      OR
      (SUBSTR(MI.ACCTNO,7,4) LIKE '1141'
       AND MI.CUSTID IN('0001001481' ,'0001000559','0001000262','0001000288','0001000713','0001003414')
          )
            )
AND SUBSTR(GL.ACCTNO,1,4) LIKE  V_STRBRID
            
 UNION ALL

SELECT MI.ACCTNO ,GL.DORC,TL.TXDESC,(CASE  WHEN GL.DORC ='C' THEN  GL.AMT ELSE 0 END) CAMT,
(CASE WHEN GL.DORC ='D' THEN GL.AMT ELSE 0 END ) DAMT
 ,TL.BUSDATE ,MI.TXDATE ,MI.TXNUM,TL.TLTXCD ,TLFLD.CVALUE AFACCTNO,MI.CUSTID
FROM MITRAN MI,
(
SELECT * FROM  TLLOGALL
WHERE TLTXCD  IN ('1140','1141','1100','1101')
 AND BUSDATE =TO_DATE( I_DATE  ,'DD/MM/YYYY')
)TL
,TLLOGFLDALL TLFLD,GLTRANA GL
WHERE TL.TXNUM =TLFLD.TXNUM
AND  TL.TXDATE =TLFLD.TXDATE
AND TL.TXNUM =GL.TXNUM
AND TL.TXDATE =GL.TXDATE
AND TLFLD.FLDCD  = '03'
AND GL.TXNUM =MI.TXNUM
AND GL.TXDATE =MI.TXDATE
AND GL.DORC =MI.DORC
AND GL.SUBTXNO =MI.SUBTXNO
AND GL.ACCTNO =MI.ACCTNO
AND  ((SUBSTR(GL.ACCTNO,7,4) LIKE '1121'
      AND SUBSTR(GL.ACCTNO,8,3) IN ( '010','020','040','050','080','090')  )
      OR
      (SUBSTR(MI.ACCTNO,7,4) LIKE '1141'
       AND MI.CUSTID IN('0001001481' ,'0001000559','0001000262','0001000288','0001000713','0001003414')
          )
            )
AND SUBSTR(GL.ACCTNO,1,4) LIKE  V_STRBRID;



 

            


 EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
/
