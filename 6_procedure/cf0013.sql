SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE cf0013 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   F_DATE         IN       VARCHAR2,
   T_DATE         IN       VARCHAR2,
   PV_CUSTODYCD   IN       VARCHAR2,
   PV_AFACCTNO    IN       VARCHAR2,
   SYMBOL         IN       VARCHAR2,
   TLID           IN       VARCHAR2,
   TLTXCD        IN       VARCHAR2
)
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
-- BAO CAO TAI KHOAN SE KHACH HANG
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- NAMNT   20-DEC-06  CREATED
-- ---------   ------  -------------------------------------------
   V_STROPTION     VARCHAR2 (5);            -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID       VARCHAR2 (4);
   V_STRCUSTODYCD  VARCHAR2(20);                   -- USED WHEN V_NUMOPTION > 0
   V_STRAFACCTNO   VARCHAR2 (20);
   V_STRSYMBOL     VARCHAR2 (20);
   V_STRFULLNAME  VARCHAR2 (100);
   V_STRADDRESS    VARCHAR2 (500);
   CUR             PKG_REPORT.REF_CURSOR;
    V_STRTLID           VARCHAR2(6);
   V_strtltxcd  varchar2(10);
BEGIN
   V_STRTLID:= TLID;
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

    IF (PV_CUSTODYCD <> 'ALL')
   THEN
      V_STRCUSTODYCD :=  PV_CUSTODYCD;
   ELSE
      V_STRCUSTODYCD := '%%';
   END IF;


   -- GET REPORT'S PARAMETERS
  IF (PV_AFACCTNO <> 'ALL')
   THEN
      V_STRAFACCTNO :=  PV_AFACCTNO;
   ELSE
      V_STRAFACCTNO := '%%';
   END IF;

 IF (SYMBOL <> 'ALL')
   THEN
      V_STRSYMBOL := replace(SYMBOL,' ','_');
   ELSE
      V_STRSYMBOL := '%%';
   END IF;

 if(upper(TLTXCD) = 'ALL' or LENGTH(TLTXCD) <= 1 ) then
        V_strtltxcd := '%';
    else
        V_strtltxcd := TLTXCD;
    end if;
      -- END OF GETTING REPORT'S PARAMETERS

OPEN    CUR
FOR
SELECT CF.FULLNAME,CF.ADDRESS
 FROM AFMAST AF,CFMAST CF
WHERE AF.custid =CF.custid
AND AF.ACCTNO  LIKE  V_STRAFACCTNO
AND CF.CUSTODYCD like V_STRCUSTODYCD
and exists (select gu.grpid from tlgrpusers gu where af.careby = gu.grpid and gu.tlid = V_STRTLID )
;

LOOP
  FETCH    CUR
  INTO V_STRFULLNAME, V_STRADDRESS ;
  EXIT WHEN    CUR%NOTFOUND;
END LOOP;
CLOSE    CUR;


   -- GET REPORT'S DATA`

      OPEN PV_REFCURSOR
       FOR


      SELECT V_STRFULLNAME FULLNAME,V_STRADDRESS ADDRESS,  BE_BALANCE.BE_BALANCE,BE_BALANCE.AFACCTNO,BALANCE.*,V_STRCUSTODYCD my_custodycd, V_STRAFACCTNO my_acctno
          FROM
---------SO DU DAU KY SE
          (  SELECT  NVL((SE.TRADE+SE.secured +SE.mortage  - DTL.B),0)  BE_BALANCE, DTL.ACCTNO,substr( DTL.ACCTNO,1,10) AFACCTNO
          FROM SEMAST SE,SBSECURITIES SB,(
            SELECT SUM(A.AMT) B,A.ACCTNO  ACCTNO
                FROM (SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                   WHEN APP.TXTYPE = 'C' THEN TR.NAMT
                                   ELSE 0   END )) AMT,TR.ACCTNO ACCTNO
                FROM APPTX APP, SETRAN TR ,TLLOG TL
                WHERE TR.TXCD = APP.TXCD
                    AND TR.tltxcd like V_strtltxcd
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND APP.APPTYPE = 'SE'
                    AND TR.namt <> 0
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
                    AND  TL.BUSDATE  >= TO_DATE (F_DATE  ,'DD/MM/YYYY')
               GROUP BY TR.ACCTNO
           UNION ALL
              SELECT   SUM ((CASE WHEN APP.TXTYPE = 'D'THEN -TR.NAMT
                                 WHEN  APP.TXTYPE = 'C'THEN TR.NAMT
                                 ELSE 0 END )) AMT,TR.ACCTNO ACCTNO
              FROM APPTX APP, SETRANA TR,TLLOGALL TL
              WHERE TR.TXCD = APP.TXCD
                    AND TR.tltxcd like V_strtltxcd
                    AND TL.TXNUM =TR.TXNUM
                    AND TL.DELTD <>'Y'
                    AND TL.TXDATE =TR.TXDATE
                    AND APP.APPTYPE = 'SE'
                    AND TR.namt <> 0
                    AND APP.TXTYPE IN ('C', 'D')
                    AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
                    AND  TL.BUSDATE  >= TO_DATE (F_DATE  ,'DD/MM/YYYY')
              GROUP BY TR.ACCTNO
                ) A
                  GROUP BY A.ACCTNO)DTL
       WHERE  SE.ACCTNO =DTL.ACCTNO
       AND  SUBSTR(SE.ACCTNO,11,6)=SB.CODEID
       AND  SUBSTR(DTL.ACCTNO,1,10) LIKE V_STRAFACCTNO
       AND  SB.SYMBOL LIKE V_STRSYMBOL
       AND  SUBSTR(SE.ACCTNO,1,4) LIKE V_STRBRID
       and sb.SECTYPE <>'004'
       )BE_BALANCE,
----------SO DU SE PHAT SINH
  (
----------GIAO DICH KHAC LENH
SELECT  SETR.ACCTNO ACCTNO, TO_CHAR(SB.SYMBOL) SYMBOL,TL.BUSDATE BUSDATE,
 TL.TXDATE TXDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION, tl.tltxcd,
(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, '' orderid

 FROM
 (
    SELECT * FROM TLLOG
    WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY')
    AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
    AND TLTXCD IN
   ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88'and tltxcd not in ('2297','2298','2250','2252') or  TLTXCD  IN('8878' ,'8879','2248'))

 ) TL, APPTX APP,SETRAN SETR, SBSECURITIES SB
WHERE
     TL.TXNUM = SETR.TXNUM
     AND SETR.tltxcd like V_strtltxcd
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
UNION ALL

 SELECT  SETR.ACCTNO ACCTNO, TO_CHAR(SB.SYMBOL) SYMBOL,TL.BUSDATE BUSDATE,
 TL.TXDATE TXDATE, TL.TXNUM TXNUM, TO_CHAR(TL.TXDESC) DESCRIPTION, tl.tltxcd,
(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, '' ORDERID

 FROM
 (
    SELECT * FROM TLLOGALL
    WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY')
    AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
    AND TLTXCD IN
       ( SELECT  TLTXCD FROM TLTX  WHERE  SUBSTR(TLTXCD,1,2) <> '88'and tltxcd not in ('2297','2298','2250','2252') or  TLTXCD  IN('8878' ,'8879','2248'))
 ) TL, APPTX APP,SETRANA SETR, SBSECURITIES SB
 WHERE   TL.TXNUM = SETR.TXNUM
         AND SETR.tltxcd like V_strtltxcd
         AND TL.TXDATE =SETR.TXDATE
         AND SETR.TXCD = APP.TXCD
         AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
         AND APP.APPTYPE = 'SE'
         AND APP.TXTYPE IN ('C', 'D')
         AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
         AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
         AND  SETR.NAMT<>0
         AND TL.DELTD<>'Y'
  UNION ALL
-------NHUNG GIAO DICH LENH
  SELECT  MAX(SETR.ACCTNO) ACCTNO,TO_CHAR( MAX(SB.SYMBOL)) SYMBOL,  MAX(TL.BUSDATE) BUSDATE
  , MAX(TL.TXDATE) TXDATE, MAX(TL.TXNUM) TXNUM, TO_CHAR(MAX(TL.TXDESC)) DESCRIPTION, tl.tltxcd,
 sum(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
 sum(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, SETR.ref ORDERID

 FROM
 ( SELECT * FROM TLLOG
    WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY')
    AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867','2248')
 ) TL, APPTX APP,SETRAN SETR, SBSECURITIES SB
 WHERE   TL.TXNUM = SETR.TXNUM
     AND SETR.tltxcd like V_strtltxcd
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN ('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
  GROUP BY SETR.ref,APP.TXTYPE, tl.tltxcd

UNION ALL

SELECT  MAX(SETR.ACCTNO) ACCTNO,TO_CHAR( MAX(SB.SYMBOL)) SYMBOL,  MAX(TL.BUSDATE) BUSDATE
  , MAX(TL.TXDATE) TXDATE, MAX(TL.TXNUM) TXNUM, TO_CHAR(MAX(TL.TXDESC)) DESCRIPTION, tl.tltxcd,
  sum(CASE WHEN APP.TXTYPE ='C' THEN SETR.NAMT ELSE 0 END)CAMT ,
  sum(CASE WHEN APP.TXTYPE ='D' THEN SETR.NAMT ELSE 0 END)DAMT, SETR.ref ORDERID

FROM
(
    SELECT * FROM TLLOGALL
    WHERE BUSDATE >= TO_DATE (F_DATE, 'DD/MM/YYYY')
    AND BUSDATE <= TO_DATE (T_DATE, 'DD/MM/YYYY')
    AND TLTXCD  IN( '8824' ,'8823', '8868', '8867','2248')
) TL, APPTX APP,SETRANA SETR,SBSECURITIES SB
  WHERE   TL.TXNUM = SETR.TXNUM
     AND SETR.tltxcd like V_strtltxcd
     AND TL.TXDATE =SETR.TXDATE
     AND SETR.TXCD = APP.TXCD
     AND SB.CODEID=SUBSTR (SETR.ACCTNO, 11, 6)
     AND APP.APPTYPE = 'SE'
     AND APP.TXTYPE IN ('C', 'D')
     AND TRIM (APP.FIELD) IN('TRADE','SECURED','MORTAGE','BLOCKED','EMKQTTY','WITHDRAW','BLOCKWITHDRAW','DTOCLOSE','BLOCKDTOCLOSE')
     AND  SUBSTR(SETR.ACCTNO,1,10) LIKE V_STRAFACCTNO
     AND  SETR.NAMT<>0
     AND TL.DELTD<>'Y'
      GROUP BY SETR.ref,APP.TXTYPE,tl.tltxcd
) BALANCE, cfmast CF,AFMAST AF
    WHERE BE_BALANCE.ACCTNO = BALANCE.ACCTNO
          AND AF.ACCTNO=BE_BALANCE.AFACCTNO(+)
          AND CF.custid=AF.custid
          AND CF.CUSTODYCD=V_STRCUSTODYCD
          and exists (select gu.grpid from tlgrpusers gu where af.careby = gu.grpid and gu.tlid = V_STRTLID );
        --   ORDER BY BALANCE.BUSDATE,BALANCE.TXNUM
/*
select V_STROPTION STROPTION,
   V_STRBRID STRBRID,
   V_STRCUSTODYCD  STRCUSTODYCD,
   V_STRAFACCTNO  STRAFACCTNO,
   V_STRSYMBOL  STRSYMBOL,
   V_STRFULLNAME STRFULLNAME,
   V_STRADDRESS STRADDRESS,
    V_STRTLID  STRTLID ,
   V_strtltxcd strtltxcd
   from dual;
*/
EXCEPTION
   WHEN OTHERS
   THEN
      RETURN;
END;                                                              -- PROCEDURE

 
 
 
 
 
 
 
 
 
 
/
