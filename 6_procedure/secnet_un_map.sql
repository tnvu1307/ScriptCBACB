SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE secnet_un_map (pv_strTXNUM IN VARCHAR2, pv_strTXDATE in varchar2)
IS
-- Purpose:
--
-- MODIFICATION HISTORY
-- Person      Date        Comments
-- DUNGNH      06/08/2013
-- ---------   ------  -------------------------------------------
    V_DI_TXNUM      VARCHAR2(20);
    V_DI_TXDATE     DATE;
    V_PTYPE         varchar2(1);

    V_AUTOID_IN     NUMBER;
    V_AUTOID_OUT    NUMBER;
    V_NETQTTY       NUMBER;

    V_STRAFACCTNO   VARCHAR2(20);
    V_STRSYMBOL     VARCHAR2(20);
    V_COUNT_out     NUMBER;
    V_COUNT_IN      NUMBER;


    CURSOR CURSECIN IS
        SELECT NET.INID, NET.NETQTTY, NET.OUTID
        FROM SECNET NET, SECMAST MST
        WHERE NET.OUTID = MST.AUTOID AND NET.DELTD = 'N'
            AND MST.TXNUM = V_DI_TXNUM AND MST.TXDATE = V_DI_TXDATE;

    CURSOR CURSECOUT IS
        SELECT NET.INID, NET.NETQTTY, NET.OUTID
        FROM SECNET NET, SECMAST MST
        WHERE NET.INID = MST.AUTOID AND NET.DELTD = 'N'
            AND MST.TXNUM = V_DI_TXNUM AND MST.TXDATE = V_DI_TXDATE;

BEGIN
    V_DI_TXNUM      := PV_STRTXNUM;
    V_DI_TXDATE     := TO_DATE(PV_STRTXDATE,'DD/MM/RRRR');

    SELECT COUNT(*) INTO V_COUNT_out
    FROM SECMAST WHERE TXNUM = V_DI_TXNUM AND TXDATE = V_DI_TXDATE AND ptype = 'O';

    SELECT COUNT(*) INTO V_COUNT_IN
    FROM SECMAST WHERE TXNUM = V_DI_TXNUM AND TXDATE = V_DI_TXDATE AND ptype = 'I';


    if(V_COUNT_out >= 1) then
        ---KHI HUY GIAO DICH XUAT CHI CAN BO CAC LAN MAP VA CAP NHAT GIAO DICH XUAT DELTD = 'Y'
        OPEN CURSECIN;
        LOOP
             FETCH CURSECIN INTO V_AUTOID_IN, V_NETQTTY, V_AUTOID_OUT;
                EXIT WHEN CURSECIN%NOTFOUND ;
             UPDATE SECMAST SET MAPQTTY = GREATEST(MAPQTTY-V_NETQTTY,0), STATUS = 'P'
             WHERE AUTOID = V_AUTOID_IN;
             UPDATE SECNET SET DELTD = 'Y'
             WHERE INID = V_AUTOID_IN AND OUTID = V_AUTOID_OUT;
        END LOOP;
        CLOSE CURSECIN;
    ELSE
        ---KHI HUY GIAO DICH NHAP CAN BO CAC LAN XUAT DA MAP VA MAP LAI LAN XUAT DO.
        OPEN CURSECOUT;
        OPEN CURSECIN;
        LOOP
             FETCH CURSECIN INTO V_AUTOID_IN, V_NETQTTY, V_AUTOID_OUT;
                EXIT WHEN CURSECIN%NOTFOUND;
             UPDATE SECMAST SET MAPQTTY = GREATEST(MAPQTTY-V_NETQTTY,0), STATUS = 'P'
             WHERE AUTOID = V_AUTOID_OUT;

             UPDATE SECNET SET DELTD = 'Y'
             WHERE INID = V_AUTOID_IN AND OUTID = V_AUTOID_OUT;

             BEGIN
                 SELECT ACCTNO, CODEID INTO V_STRAFACCTNO, V_STRSYMBOL
                 FROM SECMAST WHERE AUTOID = V_AUTOID_OUT AND DELTD = 'N';
             EXCEPTION
             WHEN OTHERS THEN
                V_STRAFACCTNO := NULL;
                V_STRSYMBOL := NULL;
             END;
             if(V_STRAFACCTNO <> NULL)then
                SECNET_MAP(V_STRAFACCTNO, V_STRSYMBOL,V_AUTOID_OUT);
             end if;
        END LOOP;

        CLOSE CURSECIN;
        CLOSE CURSECOUT;

    END IF;

    UPDATE SECMAST SET DELTD = 'Y'
    WHERE TXNUM = V_DI_TXNUM AND TXDATE = V_DI_TXDATE;

EXCEPTION
   WHEN OTHERS THEN
        BEGIN
            dbms_output.put_line('Error... ');
            return;
        END;
END;

 
 
 
 
 
 
 
 
 
 
/
