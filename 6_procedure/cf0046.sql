SET DEFINE OFF;
CREATE OR REPLACE PROCEDURE cf0046 (
   PV_REFCURSOR   IN OUT   PKG_REPORT.REF_CURSOR,
   OPT            IN       VARCHAR2,
   BRID           IN       VARCHAR2,
   I_DATE         IN       VARCHAR2,
   PV_CUSTODYCD      IN       VARCHAR2
)
IS
--
-- PURPOSE: BRIEFLY EXPLAIN THE FUNCTIONALITY OF THE PROCEDURE
--
-- MODIFICATION HISTORY
-- PERSON      DATE    COMMENTS
-- Hien.vu
-- ---------   ------  -------------------------------------------
   V_STROPTION        VARCHAR2 (5);       -- A: ALL; B: BRANCH; S: SUB-BRANCH
   V_STRBRID          VARCHAR2 (4);              -- USED WHEN V_NUMOPTION > 0

   V_STRCUSTODYCD     VARCHAR2(20);
   V_IN_DATE          DATE;

-- DECLARE PROGRAM VARIABLES AS SHOWN ABOVE
BEGIN
-- insert into temp_bug(text) values('CF0001');commit;
   V_STROPTION := OPT;

   IF (V_STROPTION <> 'A') AND (BRID <> 'ALL')
   THEN
      V_STRBRID := BRID;
   ELSE
      V_STRBRID := '%%';
   END IF;

   -- GET REPORT'S PARAMETERS


   V_IN_DATE := TO_DATE(I_DATE,'DD/MM/RRRR');
   IF(UPPER(PV_CUSTODYCD) = 'ALL' OR PV_CUSTODYCD IS NULL) THEN
        V_STRCUSTODYCD := '%';
   ELSE
        V_STRCUSTODYCD := UPPER(PV_CUSTODYCD);
   END IF;


   -- END OF GETTING REPORT'S PARAMETERS
   -- GET REPORT'S DATA
      OPEN PV_REFCURSOR
       FOR
          /*
2247 : gui yeu cau. (chuyen CK tu TRADE va BLOCKED sang DTOCLOSE va BLOCKDTOCLOSE) cap nhat trang thai = 'N'
2248 : VSD da xac nhan. (cat CK tu DTOCLOSE va BLOCKDTOCLOSE)
2290 : VSD tu choi. (chuyen CK tu DTOCLOSE va BLOCKDTOCLOSE sang TRADE va BLOCKED) cap nhat trang thai = 'A'
*/
    SELECT I_DATE INDATE, SE.TXDATE, SE.CUSTODYCD, SE.FULLNAME, SE.CUSTID, SE.REFCUSTODYCD, SE.REFINWARD, SE.TLNAME,
        SE.TRADEPLACE, SE.TRADE, SE.BLOCKED, SE.DTOCLOSE, SE.BLOCKDTOCLOSE, NVL(TL2.MSGAMT,0) MSGAMT,
        (CASE WHEN NVL(TL2.MSGAMT,0) > 0 AND (SE.TRADE + SE.BLOCKED) <> 0 THEN 'VSDTC'
            ELSE (CASE  WHEN (SE.TRADE + SE.BLOCKED + SE.DTOCLOSE+SE.BLOCKDTOCLOSE) = 0 THEN 'VSDXN'
                        WHEN (SE.DTOCLOSE+SE.BLOCKDTOCLOSE) <> 0 and (SE.TRADE + SE.BLOCKED) = 0 THEN 'VSDYC'
                        WHEN (SE.TRADE + SE.BLOCKED) <> 0 THEN 'VSDCG'
                        ELSE 'NOTVSD' END
                    ) END) STATUS
    FROM
    (
        SELECT TR.TXDATE, CF.CUSTODYCD, CF.FULLNAME, TR.CUSTID, TR.REFCUSTODYCD, TR.REFINWARD, PR.TLNAME,
            SE.TRADEPLACE, SE.TRADE, SE.BLOCKED, SE.DTOCLOSE, SE.BLOCKDTOCLOSE
        FROM SENDSETOCLOSE TR, VW_TLLOG_ALL TL, TLPROFILES PR, CFMAST CF,
            (
                SELECT CF.CUSTODYCD, AL.CDCONTENT TRADEPLACE, SUM(SE.TRADE) TRADE, SUM(SE.BLOCKED) BLOCKED,
                    SUM(SE.DTOCLOSE) DTOCLOSE, SUM(SE.BLOCKDTOCLOSE) BLOCKDTOCLOSE
                FROM SEMAST SE, SBSECURITIES SB, ALLCODE AL, CFMAST CF, SBSECURITIES SB1
                WHERE NVL(SB.REFCODEID,SB.CODEID) = SB1.CODEID
                    AND SB1.TRADEPLACE = AL.CDVAL
                    AND SE.CODEID = SB1.CODEID
                    AND AL.CDTYPE = 'SE' AND AL.CDNAME = 'TRADEPLACE'
                    AND SE.CUSTID = CF.CUSTID
                    AND CF.CUSTODYCD LIKE V_STRCUSTODYCD
                GROUP BY CF.CUSTODYCD, AL.CDCONTENT
            ) SE
        WHERE TR.DELTD <> 'Y' AND TR.TXNUM = TL.TXNUM AND TR.TXDATE = TL.TXDATE
            AND TL.TLID = PR.TLID AND TR.CUSTID =  CF.CUSTID
            AND CF.CUSTODYCD = SE.CUSTODYCD
            AND TR.TXDATE >= V_IN_DATE
    ) SE
    LEFT JOIN
    (
       SELECT CF.CUSTODYCD, SUM(MSGAMT) MSGAMT, MAX(TL.TXDATE) TXDATE,  al.cdcontent
       FROM VW_TLLOG_ALL TL, SEMAST SE, CFMAST CF,
            SBSECURITIES SB, ALLCODE AL, SBSECURITIES SB1
       WHERE TL.TLTXCD = '2290'
           AND TL.MSGACCT = SE.ACCTNO AND SE.CUSTID = CF.CUSTID
           AND NVL(SB.REFCODEID,SB.CODEID) = SB1.CODEID
            AND SB1.TRADEPLACE = AL.CDVAL
            AND SE.CODEID = SB1.CODEID
            AND AL.CDTYPE = 'SE' AND AL.CDNAME = 'TRADEPLACE'
       GROUP BY CF.CUSTODYCD,  al.cdcontent
    ) TL2
    ON SE.CUSTODYCD = TL2.CUSTODYCD
        and se.TRADEPLACE = tl2.cdcontent
        AND TL2.TXDATE >= SE.TXDATE
    LEFT JOIN
    (
       SELECT CF.CUSTODYCD, SUM(MSGAMT) MSGAMT, MAX(TL.TXDATE) TXDATE
       FROM VW_TLLOG_ALL TL, AFMAST AF, CFMAST CF
       WHERE TL.TLTXCD = '2291'
           AND TL.MSGACCT = AF.ACCTNO AND AF.CUSTID = CF.CUSTID
       GROUP BY CF.CUSTODYCD
    ) TL3
    ON SE.CUSTODYCD = TL3.CUSTODYCD
        AND TL3.TXDATE >= SE.TXDATE
    where nvl(TL3.CUSTODYCD,'XXX') = 'XXX'
    ;
 EXCEPTION
   WHEN OTHERS
   THEN
    --insert into temp_bug(text) values('CF0001');commit;
      RETURN;
END;                                                              -- PROCEDURE
 
 
 
 
 
 
 
 
 
 
/
