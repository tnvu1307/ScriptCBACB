SET DEFINE OFF;
CREATE OR REPLACE TRIGGER TRG_VSDTXREQ_BEFORE 
 BEFORE
   UPDATE OF msgstatus
 ON vsdtxreq
REFERENCING NEW AS NEWVAL OLD AS OLDVAL
 FOR EACH ROW
DECLARE
    L_COUNT NUMBER;
    L_MSGID NUMBER;
BEGIN

    SELECT COUNT(1) INTO L_COUNT FROM VSDTRFCODE WHERE TRFCODE = :NEWVAL.TRFCODE AND BANKCODE = 'CBP';

    IF L_COUNT > 0 THEN
        IF :NEWVAL.MSGSTATUS IN ('A','N') THEN
            SELECT COUNT(1) INTO L_COUNT FROM SWIFT_MULTILREQ_LOG WHERE REQID = :NEWVAL.REQID AND STATUS = 'P' ORDER BY MSGID;

            IF L_COUNT > 0 THEN
                UPDATE SWIFT_MULTILREQ_LOG SET STATUS = :NEWVAL.MSGSTATUS WHERE MSGID = (
                    SELECT TMP.MSGID
                    FROM (
                        SELECT MSGID FROM SWIFT_MULTILREQ_LOG WHERE REQID = :NEWVAL.REQID AND STATUS = 'P' ORDER BY MSGID
                    ) TMP
                    WHERE ROWNUM = 1
                );
            END IF;
        END IF;

        IF :OLDVAL.MSGSTATUS = 'N' THEN
            :NEWVAL.MSGSTATUS := 'N';
        END IF;
    END IF;
END;
/
